<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Concurrency and Threads &mdash; Distributed Systems Updated 2021-09-25 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Distributed Systems and Storage" href="../storage/storage.html" />
    <link rel="prev" title="Networking Primer" href="../networking/networking.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> Distributed Systems
          </a>
              <div class="version">
                Updated 2021-09-25
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../issues/issues.html">Introduction and Issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="../networking/networking.html">Networking Primer</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Concurrency and Threads</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#threads-vs-processes">Threads vs Processes</a></li>
<li class="toctree-l2"><a class="reference internal" href="#what-are-processes-threads">What are Processes, Threads?</a></li>
<li class="toctree-l2"><a class="reference internal" href="#common-threading-use-cases">Common Threading Use Cases</a></li>
<li class="toctree-l2"><a class="reference internal" href="#mutual-exclusion">Mutual Exclusion</a></li>
<li class="toctree-l2"><a class="reference internal" href="#tools-for-achieving-mutual-exclusion">Tools for Achieving Mutual Exclusion</a></li>
<li class="toctree-l2"><a class="reference internal" href="#mutex-example-java">Mutex Example/Java</a></li>
<li class="toctree-l2"><a class="reference internal" href="#semaphore-example">Semaphore Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="#barrier">Barrier</a></li>
<li class="toctree-l2"><a class="reference internal" href="#deadlock-a-classic-problem">Deadlock - a classic problem</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fork">Fork</a></li>
<li class="toctree-l2"><a class="reference internal" href="#diner0">Diner0</a></li>
<li class="toctree-l2"><a class="reference internal" href="#diners0">Diners0</a></li>
<li class="toctree-l2"><a class="reference internal" href="#diners1-eliminating-deadlock-with-resource-enumeration">Diners1 - eliminating deadlock with resource enumeration</a></li>
<li class="toctree-l2"><a class="reference internal" href="#execution-with-deadlock">Execution - With Deadlock</a></li>
<li class="toctree-l2"><a class="reference internal" href="#deadlock-free-version">Deadlock-Free Version</a></li>
<li class="toctree-l2"><a class="reference internal" href="#common-data-structures-in-concurrent-programming">Common Data Structures in Concurrent Programming</a></li>
<li class="toctree-l2"><a class="reference internal" href="#design-considerations">Design Considerations</a></li>
<li class="toctree-l2"><a class="reference internal" href="#kernel-threads-vs-user-mode-threads">Kernel Threads vs User Mode Threads</a></li>
<li class="toctree-l2"><a class="reference internal" href="#concurrent-file-copy-example">Concurrent File Copy Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="#sequential-file-copy">Sequential File Copy</a></li>
<li class="toctree-l2"><a class="reference internal" href="#concurrent-file-copy-organization">Concurrent File Copy Organization</a></li>
<li class="toctree-l2"><a class="reference internal" href="#execution">Execution</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../storage/storage.html">Distributed Systems and Storage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../storage/storage.html#storage-devices">Storage Devices</a></li>
<li class="toctree-l1"><a class="reference internal" href="../storage/storage.html#local-storage">Local Storage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../storage/storage.html#distributed-filesystems">Distributed Filesystems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../storage/storage.html#case-study-sun-nfs">Case Study - SUN NFS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../directories/directories.html">Directories and LDAP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../maven/maven.html">Project Build Management With Maven</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ci/ci.html">Continuous Integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../clocks/clocks.html">Clocks and Synchronization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../trans/trans.html">Distributed Transactions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dns/dns.html">Domain Name Service</a></li>
<li class="toctree-l1"><a class="reference internal" href="../queue/queue.html">Distributed Queues</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mpi/mpi.html">Message Passing Interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../smtp/smtp.html">SMTP</a></li>
<li class="toctree-l1"><a class="reference internal" href="../corba/corba.html">Object Brokers and CORBA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rest/rest.html">REST and Web Services</a></li>
<li class="toctree-l1"><a class="reference internal" href="../nosql/nosql.html">NoSQL Databases</a></li>
<li class="toctree-l1"><a class="reference internal" href="../agents/agents.html">Distributed Agents</a></li>
<li class="toctree-l1"><a class="reference internal" href="../apache_spark/apache_spark.html">Apache Spark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../bit_torrent/bit_torrent.html">BitTorrent</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hadoop/hadoop.html">Hadoop Distributed File System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../message_queues/message_queues.html">Message Queues</a></li>
<li class="toctree-l1"><a class="reference internal" href="../object_brokering/object_brokering.html">Object Brokering</a></li>
<li class="toctree-l1"><a class="reference internal" href="../rsync/rsync.html">File Sychronization and rsync</a></li>
<li class="toctree-l1"><a class="reference internal" href="../volunteer/volunteer.html">Volunteer Computing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cloud/cloud.html">Cloud Computing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../iot/iot.html">Internet of Things and Pervasive Systems</a></li>
<li class="toctree-l1"><a class="reference internal" href="../election/election.html">Election Algorithms</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Distributed Systems</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Concurrency and Threads</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/concurrency/concurrency.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="concurrency-and-threads">
<h1>Concurrency and Threads<a class="headerlink" href="#concurrency-and-threads" title="Permalink to this headline"></a></h1>
<section id="threads-vs-processes">
<h2>Threads vs Processes<a class="headerlink" href="#threads-vs-processes" title="Permalink to this headline"></a></h2>
<ul class="simple">
<li><dl class="simple">
<dt>Traditional Operating Systems have Processes</dt><dd><ul>
<li><p>Each process has its own address space</p></li>
<li><p>Single thread of control</p></li>
<li><p>When a process makes a system call, the process blocks until the call completes.</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>In many situations it is desirable to have multiple threads of control for:</dt><dd><ul>
<li><p>Explicit parallelism - to take advantage of multiple processors</p></li>
<li><dl class="simple">
<dt>To allow computation to continue while waiting for system calls to return</dt><dd><ul>
<li><p>example: one thread reads a file into a buffer, another thread compresses the buffer, and a final thread writes out a compressed file.</p></li>
</ul>
</dd>
</dl>
</li>
<li><p>To reduce the cost of context switching</p></li>
<li><p>Implicit parallelism - to keep a single processor busy</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</section>
<section id="what-are-processes-threads">
<h2>What are Processes, Threads?<a class="headerlink" href="#what-are-processes-threads" title="Permalink to this headline"></a></h2>
<ul>
<li><dl>
<dt>Processes have:</dt><dd><ul class="simple">
<li><p>Program counter</p></li>
<li><p>Stack</p></li>
<li><p>Register set</p></li>
<li><p>An exclusive virtual address space</p></li>
<li><p>Sandboxing from other process except to the extent that the process participates in IPC</p></li>
</ul>
<figure class="align-center">
<img alt="Process Memory Layout" src="../_images/memory_layout.png" />
</figure>
</dd>
</dl>
</li>
<li><dl>
<dt>Threads:</dt><dd><ul class="simple">
<li><p>Threads can be thought of (and are often referred to as) lightweight processes</p></li>
<li><p>Provide multiple threads of control</p></li>
<li><p>Have multiple program counters</p></li>
<li><p>Have multiple stacks</p></li>
<li><p>One parent process, the virtual address space is shared across processes</p></li>
<li><p>Each thread runs sequentially</p></li>
<li><p>In a given process with N threads, 0-i threads may be blocked, and 0-k threads are runnable or running.</p></li>
</ul>
<figure class="align-center">
<img alt="Threaded Memory Layout" src="../_images/memory_layout_multithreaded.png" />
</figure>
</dd>
</dl>
</li>
</ul>
</section>
<section id="common-threading-use-cases">
<h2>Common Threading Use Cases<a class="headerlink" href="#common-threading-use-cases" title="Permalink to this headline"></a></h2>
<ul>
<li><dl>
<dt>Client / Server - ex: file servers:</dt><dd><ul class="simple">
<li><p>One thread listens on a network socket for clients</p></li>
<li><p>When a client connects, a new thread is spawned to handle the request. This permits several clients to connect to the file server at one time because each request is handled by a separate thread of execution.</p></li>
<li><p>To send the file data, two threads can be used the first can read from the file on disk and the second can write the read buffers to the socket.</p></li>
</ul>
<figure class="align-center">
<img alt="Client-Server Thread Model" src="../_images/client_server.png" />
</figure>
</dd>
</dl>
</li>
<li><p>Example Client-Server - a TCP echo server</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span>	<span class="n">public</span> <span class="k">class</span> <span class="nc">TcpServer</span>
<span class="linenos"> 2</span>	<span class="p">{</span>
<span class="linenos"> 3</span>		<span class="n">private</span> <span class="n">Socket</span> <span class="n">_socket</span><span class="p">;</span>
<span class="linenos"> 4</span>		<span class="n">private</span> <span class="n">Thread</span> <span class="n">_serverThread</span><span class="p">;</span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span>		<span class="n">public</span> <span class="n">TcpServer</span><span class="p">()</span> <span class="p">{</span>
<span class="linenos"> 7</span>			<span class="n">_socket</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Socket</span> <span class="p">(</span><span class="n">AddressFamily</span><span class="o">.</span><span class="n">InterNetwork</span><span class="p">,</span> <span class="n">SocketType</span><span class="o">.</span><span class="n">Stream</span><span class="p">,</span> <span class="n">ProtocolType</span><span class="o">.</span><span class="n">Tcp</span><span class="p">);</span>
<span class="linenos"> 8</span>			<span class="n">_serverThread</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Thread</span> <span class="p">(</span><span class="n">Server</span><span class="p">);</span>
<span class="linenos"> 9</span>			<span class="n">_serverThread</span><span class="o">.</span><span class="n">Start</span> <span class="p">();</span>
<span class="linenos">10</span>		<span class="p">}</span>
<span class="linenos">11</span>
<span class="linenos">12</span>		<span class="n">private</span> <span class="n">void</span> <span class="n">Server</span><span class="p">()</span> <span class="p">{</span>
<span class="linenos">13</span>			<span class="n">_socket</span><span class="o">.</span><span class="n">Bind</span> <span class="p">(</span><span class="n">new</span> <span class="n">IPEndPoint</span> <span class="p">(</span><span class="n">IPAddress</span><span class="o">.</span><span class="n">Any</span><span class="p">,</span> <span class="mi">8080</span><span class="p">));</span>
<span class="linenos">14</span>			<span class="n">_socket</span><span class="o">.</span><span class="n">Listen</span> <span class="p">(</span><span class="mi">100</span><span class="p">);</span>
<span class="linenos">15</span>			<span class="k">while</span> <span class="p">(</span><span class="n">true</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos">16</span>				<span class="n">var</span> <span class="n">serverClientSocket</span> <span class="o">=</span> <span class="n">_socket</span><span class="o">.</span><span class="n">Accept</span> <span class="p">();</span>
<span class="linenos">17</span>				<span class="n">new</span> <span class="n">Thread</span> <span class="p">(</span><span class="n">Server</span><span class="p">)</span> <span class="p">{</span> <span class="n">IsBackground</span> <span class="o">=</span> <span class="n">true</span> <span class="p">}</span><span class="o">.</span><span class="n">Start</span> <span class="p">(</span><span class="n">serverClientSocket</span><span class="p">);</span>
<span class="linenos">18</span>			<span class="p">}</span>
<span class="linenos">19</span>		<span class="p">}</span>
<span class="linenos">20</span>
<span class="linenos">21</span>		<span class="n">private</span> <span class="n">void</span> <span class="n">ServerThread</span><span class="p">(</span><span class="n">Object</span> <span class="n">arg</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos">22</span>			<span class="k">try</span> <span class="p">{</span>
<span class="linenos">23</span>				<span class="n">var</span> <span class="n">socket</span> <span class="o">=</span> <span class="p">(</span><span class="n">Socket</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
<span class="linenos">24</span>				<span class="n">socket</span><span class="o">.</span><span class="n">Send</span> <span class="p">(</span><span class="n">Encoding</span><span class="o">.</span><span class="n">UTF8</span><span class="o">.</span><span class="n">GetBytes</span> <span class="p">(</span><span class="s2">&quot;Echo&quot;</span><span class="p">));</span>
<span class="linenos">25</span>			<span class="p">}</span> <span class="n">catch</span><span class="p">(</span><span class="n">SocketException</span> <span class="n">se</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos">26</span>				<span class="n">Console</span><span class="o">.</span><span class="n">WriteLine</span> <span class="p">(</span><span class="n">se</span><span class="o">.</span><span class="n">Message</span><span class="p">);</span>
<span class="linenos">27</span>			<span class="p">}</span>
<span class="linenos">28</span>		<span class="p">}</span>
<span class="linenos">29</span>	<span class="p">}</span>
<span class="linenos">30</span>
<span class="linenos">31</span>	<span class="n">public</span> <span class="k">class</span> <span class="nc">TcpClient</span> <span class="p">{</span>
<span class="linenos">32</span>		<span class="n">public</span> <span class="n">void</span> <span class="n">ConnectToServer</span><span class="p">()</span> <span class="p">{</span>
<span class="linenos">33</span>			<span class="n">var</span> <span class="n">socket</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Socket</span> <span class="p">(</span><span class="n">AddressFamily</span><span class="o">.</span><span class="n">InterNetwork</span><span class="p">,</span> <span class="n">SocketType</span><span class="o">.</span><span class="n">Stream</span><span class="p">,</span> <span class="n">ProtocolType</span><span class="o">.</span><span class="n">Tcp</span><span class="p">);</span>
<span class="linenos">34</span>			<span class="n">socket</span><span class="o">.</span><span class="n">Connect</span> <span class="p">(</span><span class="n">new</span> <span class="n">IPEndPoint</span> <span class="p">(</span><span class="n">IPAddress</span><span class="o">.</span><span class="n">Parse</span><span class="p">(</span><span class="s2">&quot;127.0.0.1&quot;</span><span class="p">),</span> <span class="mi">8080</span><span class="p">));</span>
<span class="linenos">35</span>			<span class="n">var</span> <span class="n">buffer</span> <span class="o">=</span> <span class="n">new</span> <span class="n">byte</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
<span class="linenos">36</span>			<span class="n">var</span> <span class="n">receivedBytes</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">Receive</span> <span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
<span class="linenos">37</span>			<span class="k">if</span> <span class="p">(</span><span class="n">receivedBytes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos">38</span>				<span class="n">Array</span><span class="o">.</span><span class="n">Resize</span> <span class="p">(</span><span class="n">ref</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">receivedBytes</span><span class="p">);</span>
<span class="linenos">39</span>				<span class="n">Console</span><span class="o">.</span><span class="n">WriteLine</span> <span class="p">(</span><span class="n">System</span><span class="o">.</span><span class="n">Text</span><span class="o">.</span><span class="n">Encoding</span><span class="o">.</span><span class="n">UTF8</span><span class="o">.</span><span class="n">GetString</span> <span class="p">(</span><span class="n">buffer</span><span class="p">));</span>
<span class="linenos">40</span>			<span class="p">}</span>
<span class="linenos">41</span>		<span class="p">}</span>
<span class="linenos">42</span>	<span class="p">}</span>
</pre></div>
</div>
<ul>
<li><dl>
<dt>Parallel computation:</dt><dd><ul class="simple">
<li><p>An algorithm is designed to solve some small part or subproblem of a larger problem</p></li>
<li><p>To the extent that the subproblems are not inter-dependent, they can be executed in parallel</p></li>
<li><p>Multiple threads can work against a common task queue.</p></li>
</ul>
<figure class="align-center">
<img alt="Parallel Thread Model" src="../_images/parallel_threads.png" />
</figure>
</dd>
</dl>
</li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The focus of this course is on <em>distributed</em> (not <em>parallel</em>) systems. Nevertheless, you may find that you want to take advantage of parallel computing in your work. We encourage you to read Christopher and Thiruvathukal, <a class="reference external" href="http://hpjpc.googlecode.com">http://hpjpc.googlecode.com</a>, which contains many examples of parallel algorithms in Java. You may also find Läufer, Lewis, and Thiruvathukal’s Scala workshop tutorial helpful. See <a class="reference external" href="http://scalaworkshop.cs.luc.edu">http://scalaworkshop.cs.luc.edu</a>.</p>
</div>
<ul class="simple">
<li><p>Example Parallel Computation - factoring an integer</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span>	<span class="n">public</span> <span class="k">class</span> <span class="nc">ParallelComputationWorkItem</span> <span class="p">{</span>
<span class="linenos"> 2</span>		<span class="n">public</span> <span class="n">readonly</span> <span class="n">long</span> <span class="n">LowerBound</span><span class="p">;</span>
<span class="linenos"> 3</span>		<span class="n">public</span> <span class="n">readonly</span> <span class="n">long</span> <span class="n">UpperBound</span><span class="p">;</span>
<span class="linenos"> 4</span>		<span class="n">public</span> <span class="n">readonly</span> <span class="n">long</span> <span class="n">Number</span><span class="p">;</span>
<span class="linenos"> 5</span>		<span class="n">public</span> <span class="n">readonly</span> <span class="n">ICollection</span><span class="o">&lt;</span><span class="n">long</span><span class="o">&gt;</span> <span class="n">Divisors</span><span class="p">;</span>
<span class="linenos"> 6</span>		<span class="n">public</span> <span class="n">ParallelComputationWorkItem</span><span class="p">(</span><span class="n">long</span> <span class="n">lower</span><span class="p">,</span> <span class="n">long</span> <span class="n">upper</span><span class="p">,</span> <span class="n">long</span> <span class="n">number</span><span class="p">,</span> <span class="n">ICollection</span><span class="o">&lt;</span><span class="n">long</span><span class="o">&gt;</span> <span class="n">divisors</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos"> 7</span>			<span class="n">LowerBound</span> <span class="o">=</span> <span class="n">lower</span><span class="p">;</span>
<span class="linenos"> 8</span>			<span class="n">UpperBound</span> <span class="o">=</span> <span class="n">upper</span><span class="p">;</span>
<span class="linenos"> 9</span>			<span class="n">Number</span> <span class="o">=</span> <span class="n">number</span><span class="p">;</span>
<span class="linenos">10</span>			<span class="n">Divisors</span> <span class="o">=</span> <span class="n">divisors</span><span class="p">;</span>
<span class="linenos">11</span>		<span class="p">}</span>
<span class="linenos">12</span>	<span class="p">}</span>
<span class="linenos">13</span>
<span class="linenos">14</span>	<span class="n">public</span> <span class="k">class</span> <span class="nc">ParallelComputation</span> <span class="p">{</span>
<span class="linenos">15</span>
<span class="linenos">16</span>		<span class="n">public</span> <span class="n">void</span> <span class="n">PrintFactors</span><span class="p">(</span><span class="n">long</span> <span class="n">number</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos">17</span>			<span class="n">var</span> <span class="n">threads</span> <span class="o">=</span> <span class="n">new</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Thread</span><span class="o">&gt;</span><span class="p">();</span>
<span class="linenos">18</span>			<span class="n">var</span> <span class="n">divisors</span> <span class="o">=</span> <span class="n">new</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">long</span><span class="o">&gt;</span> <span class="p">();</span>
<span class="linenos">19</span>			<span class="n">var</span> <span class="n">cpuCount</span> <span class="o">=</span> <span class="n">Environment</span><span class="o">.</span><span class="n">ProcessorCount</span><span class="p">;</span>
<span class="linenos">20</span>			<span class="n">long</span> <span class="n">lower</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="linenos">21</span>			<span class="k">for</span> <span class="p">(</span><span class="n">var</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cpuCount</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos">22</span>				<span class="n">var</span> <span class="n">thread</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Thread</span> <span class="p">(</span><span class="n">Worker</span><span class="p">);</span>
<span class="linenos">23</span>				<span class="n">var</span> <span class="n">upper</span> <span class="o">=</span> <span class="n">lower</span> <span class="o">+</span> <span class="p">(</span><span class="n">number</span> <span class="o">/</span> <span class="n">cpuCount</span><span class="p">);</span>
<span class="linenos">24</span>				<span class="n">thread</span><span class="o">.</span><span class="n">Start</span><span class="p">(</span><span class="n">new</span> <span class="n">ParallelComputationWorkItem</span><span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">divisors</span><span class="p">));</span>
<span class="linenos">25</span>				<span class="n">threads</span><span class="o">.</span><span class="n">Add</span> <span class="p">(</span><span class="n">thread</span><span class="p">);</span>
<span class="linenos">26</span>				<span class="n">lower</span> <span class="o">=</span> <span class="n">upper</span><span class="p">;</span>
<span class="linenos">27</span>			<span class="p">}</span>
<span class="linenos">28</span>			<span class="n">foreach</span> <span class="p">(</span><span class="n">var</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos">29</span>				<span class="n">thread</span><span class="o">.</span><span class="n">Join</span> <span class="p">();</span>
<span class="linenos">30</span>			<span class="p">}</span>
<span class="linenos">31</span>			<span class="n">Console</span><span class="o">.</span><span class="n">WriteLine</span> <span class="p">(</span><span class="s2">&quot;Divisors - &quot;</span><span class="p">);</span>
<span class="linenos">32</span>			<span class="n">foreach</span> <span class="p">(</span><span class="n">var</span> <span class="n">divisor</span> <span class="ow">in</span> <span class="n">divisors</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos">33</span>				<span class="n">Console</span><span class="o">.</span><span class="n">WriteLine</span> <span class="p">(</span><span class="n">divisor</span><span class="p">);</span>
<span class="linenos">34</span>			<span class="p">}</span>
<span class="linenos">35</span>		<span class="p">}</span>
<span class="linenos">36</span>
<span class="linenos">37</span>		<span class="n">private</span> <span class="n">void</span> <span class="n">Worker</span><span class="p">(</span><span class="nb">object</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos">38</span>			<span class="n">var</span> <span class="n">workItem</span> <span class="o">=</span> <span class="p">(</span><span class="n">ParallelComputationWorkItem</span><span class="p">)</span><span class="n">args</span><span class="p">;</span>
<span class="linenos">39</span>			<span class="k">for</span> <span class="p">(</span><span class="n">var</span> <span class="n">i</span> <span class="o">=</span> <span class="n">workItem</span><span class="o">.</span><span class="n">LowerBound</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">workItem</span><span class="o">.</span><span class="n">UpperBound</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos">40</span>				<span class="k">if</span> <span class="p">(</span><span class="n">workItem</span><span class="o">.</span><span class="n">Number</span> <span class="o">%</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos">41</span>					<span class="n">lock</span> <span class="p">(</span><span class="n">workItem</span><span class="o">.</span><span class="n">Divisors</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos">42</span>						<span class="n">workItem</span><span class="o">.</span><span class="n">Divisors</span><span class="o">.</span><span class="n">Add</span> <span class="p">(</span><span class="n">i</span><span class="p">);</span>
<span class="linenos">43</span>					<span class="p">}</span>
<span class="linenos">44</span>				<span class="p">}</span>
<span class="linenos">45</span>			<span class="p">}</span>
<span class="linenos">46</span>		<span class="p">}</span>
<span class="linenos">47</span>	<span class="p">}</span>
</pre></div>
</div>
<ul>
<li><dl>
<dt>Pipeline processing:</dt><dd><ul class="simple">
<li><p>An algorithm must be executed in several stages that depend upon each other.</p></li>
<li><p>For example if there are three stages, then three threads can be launched for each of the stages. As the first thread completes some part of the total work, it can pass it to a queue for the second stage to be processed by the second thread. At this time, the first thread and second thread can work on their own stages in parallel. The same continues to the third thread for the third stage of computation.</p></li>
</ul>
<figure class="align-center">
<img alt="Pipeline Thread Model" src="../_images/pipeline_threads.png" />
</figure>
</dd>
</dl>
</li>
<li><p>Example Pipeline Processing - file compression</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="linenos">  1</span>	<span class="n">public</span> <span class="k">class</span> <span class="nc">PipelineComputation</span> <span class="p">{</span>
<span class="linenos">  2</span>		<span class="n">private</span> <span class="n">readonly</span> <span class="n">Queue</span><span class="o">&lt;</span><span class="n">byte</span><span class="p">[]</span><span class="o">&gt;</span> <span class="n">_readData</span><span class="p">;</span>
<span class="linenos">  3</span>		<span class="n">private</span> <span class="n">readonly</span> <span class="n">Queue</span><span class="o">&lt;</span><span class="n">byte</span><span class="p">[]</span><span class="o">&gt;</span> <span class="n">_compressionData</span><span class="p">;</span>
<span class="linenos">  4</span>		<span class="n">private</span> <span class="n">volatile</span> <span class="nb">bool</span> <span class="n">_reading</span> <span class="o">=</span> <span class="n">true</span><span class="p">;</span>
<span class="linenos">  5</span>		<span class="n">private</span> <span class="n">volatile</span> <span class="nb">bool</span> <span class="n">_compressing</span> <span class="o">=</span> <span class="n">true</span><span class="p">;</span>
<span class="linenos">  6</span>
<span class="linenos">  7</span>		<span class="n">public</span> <span class="n">PipelineComputation</span> <span class="p">()</span> <span class="p">{</span>
<span class="linenos">  8</span>			<span class="n">_readData</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Queue</span><span class="o">&lt;</span><span class="n">byte</span><span class="p">[]</span><span class="o">&gt;</span><span class="p">();</span>
<span class="linenos">  9</span>			<span class="n">_compressionData</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Queue</span><span class="o">&lt;</span><span class="n">byte</span><span class="p">[]</span><span class="o">&gt;</span><span class="p">();</span>
<span class="linenos"> 10</span>		<span class="p">}</span>
<span class="linenos"> 11</span>
<span class="linenos"> 12</span>		<span class="n">public</span> <span class="n">void</span> <span class="n">PerformCompression</span><span class="p">()</span> <span class="p">{</span>
<span class="linenos"> 13</span>			<span class="n">var</span> <span class="n">readerThread</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Thread</span> <span class="p">(</span><span class="n">FileReader</span><span class="p">);</span>
<span class="linenos"> 14</span>			<span class="n">var</span> <span class="n">compressThread</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Thread</span> <span class="p">(</span><span class="n">Compression</span><span class="p">);</span>
<span class="linenos"> 15</span>			<span class="n">var</span> <span class="n">writerThread</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Thread</span> <span class="p">(</span><span class="n">FileWriter</span><span class="p">);</span>
<span class="linenos"> 16</span>			<span class="n">readerThread</span><span class="o">.</span><span class="n">Start</span> <span class="p">();</span>
<span class="linenos"> 17</span>			<span class="n">compressThread</span><span class="o">.</span><span class="n">Start</span> <span class="p">();</span>
<span class="linenos"> 18</span>			<span class="n">writerThread</span><span class="o">.</span><span class="n">Start</span> <span class="p">();</span>
<span class="linenos"> 19</span>			<span class="n">readerThread</span><span class="o">.</span><span class="n">Join</span> <span class="p">();</span>
<span class="linenos"> 20</span>			<span class="n">compressThread</span><span class="o">.</span><span class="n">Join</span> <span class="p">();</span>
<span class="linenos"> 21</span>			<span class="n">writerThread</span><span class="o">.</span><span class="n">Join</span> <span class="p">();</span>
<span class="linenos"> 22</span>		<span class="p">}</span>
<span class="linenos"> 23</span>
<span class="linenos"> 24</span>		<span class="n">private</span> <span class="n">void</span> <span class="n">FileReader</span><span class="p">()</span> <span class="p">{</span>
<span class="linenos"> 25</span>			<span class="n">using</span> <span class="p">(</span><span class="n">var</span> <span class="n">stream</span> <span class="o">=</span> <span class="n">new</span> <span class="n">FileStream</span><span class="p">(</span><span class="s2">&quot;file.txt&quot;</span><span class="p">,</span> <span class="n">FileMode</span><span class="o">.</span><span class="n">Open</span><span class="p">,</span> <span class="n">FileAccess</span><span class="o">.</span><span class="n">Read</span><span class="p">))</span> <span class="p">{</span>
<span class="linenos"> 26</span>				<span class="nb">int</span> <span class="nb">len</span><span class="p">;</span>
<span class="linenos"> 27</span>				<span class="n">var</span> <span class="n">buffer</span> <span class="o">=</span> <span class="n">new</span> <span class="n">byte</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
<span class="linenos"> 28</span>				<span class="k">while</span> <span class="p">((</span><span class="nb">len</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">Read</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">buffer</span><span class="o">.</span><span class="n">Length</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos"> 29</span>					<span class="k">if</span> <span class="p">(</span><span class="nb">len</span> <span class="o">!=</span> <span class="n">buffer</span><span class="o">.</span><span class="n">Length</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos"> 30</span>						<span class="n">Array</span><span class="o">.</span><span class="n">Resize</span> <span class="p">(</span><span class="n">ref</span> <span class="n">buffer</span><span class="p">,</span> <span class="nb">len</span><span class="p">);</span>
<span class="linenos"> 31</span>					<span class="p">}</span>
<span class="linenos"> 32</span>					<span class="n">lock</span> <span class="p">(</span><span class="n">_readData</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos"> 33</span>						<span class="k">while</span> <span class="p">(</span><span class="n">_readData</span><span class="o">.</span><span class="n">Count</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos"> 34</span>							<span class="n">Monitor</span><span class="o">.</span><span class="n">Wait</span> <span class="p">(</span><span class="n">_readData</span><span class="p">);</span>
<span class="linenos"> 35</span>						<span class="p">}</span>
<span class="linenos"> 36</span>						<span class="n">_readData</span><span class="o">.</span><span class="n">Enqueue</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
<span class="linenos"> 37</span>						<span class="n">Monitor</span><span class="o">.</span><span class="n">Pulse</span> <span class="p">(</span><span class="n">_readData</span><span class="p">);</span>
<span class="linenos"> 38</span>					<span class="p">}</span>
<span class="linenos"> 39</span>				<span class="p">}</span>
<span class="linenos"> 40</span>			<span class="p">}</span>
<span class="linenos"> 41</span>			<span class="n">_reading</span> <span class="o">=</span> <span class="n">false</span><span class="p">;</span>
<span class="linenos"> 42</span>		<span class="p">}</span>
<span class="linenos"> 43</span>
<span class="linenos"> 44</span>		<span class="n">private</span> <span class="n">void</span> <span class="n">Compression</span><span class="p">()</span> <span class="p">{</span>
<span class="linenos"> 45</span>			<span class="n">var</span> <span class="n">workLeft</span> <span class="o">=</span> <span class="n">false</span><span class="p">;</span>
<span class="linenos"> 46</span>			<span class="k">while</span> <span class="p">(</span><span class="n">_reading</span> <span class="o">||</span> <span class="n">workLeft</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos"> 47</span>				<span class="n">workLeft</span> <span class="o">=</span> <span class="n">false</span><span class="p">;</span>
<span class="linenos"> 48</span>				<span class="n">byte</span><span class="p">[]</span> <span class="n">dataToCompress</span> <span class="o">=</span> <span class="n">null</span><span class="p">;</span>
<span class="linenos"> 49</span>				<span class="n">lock</span> <span class="p">(</span><span class="n">_readData</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos"> 50</span>					<span class="k">while</span> <span class="p">(</span><span class="n">_reading</span> <span class="o">&amp;&amp;</span> <span class="n">_readData</span><span class="o">.</span><span class="n">Count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos"> 51</span>						<span class="n">Monitor</span><span class="o">.</span><span class="n">Wait</span> <span class="p">(</span><span class="n">_readData</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
<span class="linenos"> 52</span>					<span class="p">}</span>
<span class="linenos"> 53</span>					<span class="n">workLeft</span> <span class="o">=</span> <span class="n">_readData</span><span class="o">.</span><span class="n">Count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">;</span>
<span class="linenos"> 54</span>					<span class="k">if</span> <span class="p">(</span><span class="n">_readData</span><span class="o">.</span><span class="n">Count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos"> 55</span>						<span class="n">dataToCompress</span> <span class="o">=</span> <span class="n">_readData</span><span class="o">.</span><span class="n">Dequeue</span> <span class="p">();</span>
<span class="linenos"> 56</span>					<span class="p">}</span>
<span class="linenos"> 57</span>				<span class="p">}</span>
<span class="linenos"> 58</span>				<span class="k">if</span> <span class="p">(</span><span class="n">dataToCompress</span> <span class="o">!=</span> <span class="n">null</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos"> 59</span>					<span class="n">var</span> <span class="n">compressed</span> <span class="o">=</span> <span class="n">Compress</span><span class="p">(</span><span class="n">dataToCompress</span><span class="p">);</span>
<span class="linenos"> 60</span>					<span class="n">lock</span> <span class="p">(</span><span class="n">_compressionData</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos"> 61</span>						<span class="k">while</span> <span class="p">(</span><span class="n">_compressionData</span><span class="o">.</span><span class="n">Count</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos"> 62</span>							<span class="n">Monitor</span><span class="o">.</span><span class="n">Wait</span> <span class="p">(</span><span class="n">_compressionData</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
<span class="linenos"> 63</span>						<span class="p">}</span>
<span class="linenos"> 64</span>						<span class="n">_compressionData</span><span class="o">.</span><span class="n">Enqueue</span> <span class="p">(</span><span class="n">compressed</span><span class="p">);</span>
<span class="linenos"> 65</span>						<span class="n">Monitor</span><span class="o">.</span><span class="n">Pulse</span> <span class="p">(</span><span class="n">_compressionData</span><span class="p">);</span>
<span class="linenos"> 66</span>					<span class="p">}</span>
<span class="linenos"> 67</span>				<span class="p">}</span>
<span class="linenos"> 68</span>			<span class="p">}</span>
<span class="linenos"> 69</span>			<span class="n">_compressing</span> <span class="o">=</span> <span class="n">false</span><span class="p">;</span>
<span class="linenos"> 70</span>		<span class="p">}</span>
<span class="linenos"> 71</span>
<span class="linenos"> 72</span>		<span class="n">private</span> <span class="n">static</span> <span class="n">byte</span><span class="p">[]</span> <span class="n">Compress</span><span class="p">(</span><span class="n">byte</span><span class="p">[]</span> <span class="n">data</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos"> 73</span>			<span class="n">var</span> <span class="n">memStream</span> <span class="o">=</span> <span class="n">new</span> <span class="n">MemoryStream</span> <span class="p">();</span>
<span class="linenos"> 74</span>			<span class="n">using</span><span class="p">(</span><span class="n">var</span> <span class="n">compressionStream</span> <span class="o">=</span> <span class="n">new</span> <span class="n">GZipStream</span><span class="p">(</span><span class="n">memStream</span><span class="p">,</span> <span class="n">CompressionMode</span><span class="o">.</span><span class="n">Compress</span><span class="p">))</span> <span class="p">{</span>
<span class="linenos"> 75</span>				<span class="n">compressionStream</span><span class="o">.</span><span class="n">Write</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Length</span><span class="p">);</span>
<span class="linenos"> 76</span>			<span class="p">}</span>
<span class="linenos"> 77</span>			<span class="k">return</span> <span class="n">memStream</span><span class="o">.</span><span class="n">ToArray</span> <span class="p">();</span>
<span class="linenos"> 78</span>		<span class="p">}</span>
<span class="linenos"> 79</span>
<span class="linenos"> 80</span>		<span class="n">private</span> <span class="n">void</span> <span class="n">FileWriter</span><span class="p">()</span> <span class="p">{</span>
<span class="linenos"> 81</span>			<span class="n">using</span> <span class="p">(</span><span class="n">var</span> <span class="n">stream</span> <span class="o">=</span> <span class="n">new</span> <span class="n">FileStream</span><span class="p">(</span><span class="s2">&quot;file.gz&quot;</span><span class="p">,</span> <span class="n">FileMode</span><span class="o">.</span><span class="n">OpenOrCreate</span><span class="p">,</span> <span class="n">FileAccess</span><span class="o">.</span><span class="n">Write</span><span class="p">))</span> <span class="p">{</span>
<span class="linenos"> 82</span>				<span class="n">var</span> <span class="n">workLeft</span> <span class="o">=</span> <span class="n">false</span><span class="p">;</span>
<span class="linenos"> 83</span>				<span class="k">while</span> <span class="p">(</span><span class="n">_compressing</span> <span class="o">||</span> <span class="n">workLeft</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos"> 84</span>					<span class="n">workLeft</span> <span class="o">=</span> <span class="n">false</span><span class="p">;</span>
<span class="linenos"> 85</span>					<span class="n">byte</span><span class="p">[]</span> <span class="n">compressedData</span> <span class="o">=</span> <span class="n">null</span><span class="p">;</span>
<span class="linenos"> 86</span>					<span class="n">lock</span> <span class="p">(</span><span class="n">_compressionData</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos"> 87</span>						<span class="k">while</span> <span class="p">(</span><span class="n">_compressionData</span><span class="o">.</span><span class="n">Count</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">_compressing</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos"> 88</span>							<span class="n">Monitor</span><span class="o">.</span><span class="n">Wait</span> <span class="p">(</span><span class="n">_compressionData</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
<span class="linenos"> 89</span>						<span class="p">}</span>
<span class="linenos"> 90</span>						<span class="n">workLeft</span> <span class="o">=</span> <span class="n">_compressionData</span><span class="o">.</span><span class="n">Count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">;</span>
<span class="linenos"> 91</span>						<span class="k">if</span> <span class="p">(</span><span class="n">_compressionData</span><span class="o">.</span><span class="n">Count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos"> 92</span>							<span class="n">compressedData</span> <span class="o">=</span> <span class="n">_compressionData</span><span class="o">.</span><span class="n">Dequeue</span> <span class="p">();</span>
<span class="linenos"> 93</span>						<span class="p">}</span>
<span class="linenos"> 94</span>					<span class="p">}</span>
<span class="linenos"> 95</span>					<span class="k">if</span> <span class="p">(</span><span class="n">compressedData</span> <span class="o">!=</span> <span class="n">null</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos"> 96</span>						<span class="n">stream</span><span class="o">.</span><span class="n">Write</span> <span class="p">(</span><span class="n">compressedData</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">compressedData</span><span class="o">.</span><span class="n">Length</span><span class="p">);</span>
<span class="linenos"> 97</span>					<span class="p">}</span>
<span class="linenos"> 98</span>				<span class="p">}</span>
<span class="linenos"> 99</span>			<span class="p">}</span>
<span class="linenos">100</span>		<span class="p">}</span>
<span class="linenos">101</span>	<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Example Pipeline Processing - a more concise and language friendly file compression</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span>	<span class="n">public</span> <span class="k">class</span> <span class="nc">ConcisePipelineComputation</span>
<span class="linenos"> 2</span>	<span class="p">{</span>
<span class="linenos"> 3</span>		<span class="n">public</span> <span class="n">ConcisePipelineComputation</span> <span class="p">()</span> <span class="p">{</span>
<span class="linenos"> 4</span>		<span class="p">}</span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span>		<span class="n">public</span> <span class="n">void</span> <span class="n">PerformCompression</span><span class="p">()</span> <span class="p">{</span>
<span class="linenos"> 7</span>			<span class="n">var</span> <span class="n">fileBlocks</span> <span class="o">=</span> <span class="n">new</span> <span class="n">ThreadedList</span><span class="o">&lt;</span><span class="n">byte</span><span class="p">[]</span><span class="o">&gt;</span><span class="p">(</span><span class="n">FileReader</span><span class="p">());</span>
<span class="linenos"> 8</span>			<span class="n">var</span> <span class="n">compressedBlocks</span> <span class="o">=</span> <span class="n">new</span> <span class="n">ThreadedList</span><span class="o">&lt;</span><span class="n">byte</span><span class="p">[]</span><span class="o">&gt;</span> <span class="p">(</span><span class="n">Compression</span><span class="p">(</span><span class="n">fileBlocks</span><span class="p">));</span>
<span class="linenos"> 9</span>			<span class="n">FileWriter</span> <span class="p">(</span><span class="n">compressedBlocks</span><span class="p">);</span>
<span class="linenos">10</span>		<span class="p">}</span>
<span class="linenos">11</span>
<span class="linenos">12</span>		<span class="n">private</span> <span class="n">IEnumerable</span><span class="o">&lt;</span><span class="n">byte</span><span class="p">[]</span><span class="o">&gt;</span> <span class="n">FileReader</span><span class="p">()</span> <span class="p">{</span>
<span class="linenos">13</span>			<span class="n">using</span> <span class="p">(</span><span class="n">var</span> <span class="n">stream</span> <span class="o">=</span> <span class="n">new</span> <span class="n">FileStream</span><span class="p">(</span><span class="s2">&quot;file.txt&quot;</span><span class="p">,</span> <span class="n">FileMode</span><span class="o">.</span><span class="n">Open</span><span class="p">,</span> <span class="n">FileAccess</span><span class="o">.</span><span class="n">Read</span><span class="p">))</span> <span class="p">{</span>
<span class="linenos">14</span>				<span class="nb">int</span> <span class="nb">len</span><span class="p">;</span>
<span class="linenos">15</span>				<span class="n">var</span> <span class="n">buffer</span> <span class="o">=</span> <span class="n">new</span> <span class="n">byte</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
<span class="linenos">16</span>				<span class="k">while</span> <span class="p">((</span><span class="nb">len</span> <span class="o">=</span> <span class="n">stream</span><span class="o">.</span><span class="n">Read</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">buffer</span><span class="o">.</span><span class="n">Length</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos">17</span>					<span class="k">if</span> <span class="p">(</span><span class="nb">len</span> <span class="o">!=</span> <span class="n">buffer</span><span class="o">.</span><span class="n">Length</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos">18</span>						<span class="n">Array</span><span class="o">.</span><span class="n">Resize</span> <span class="p">(</span><span class="n">ref</span> <span class="n">buffer</span><span class="p">,</span> <span class="nb">len</span><span class="p">);</span>
<span class="linenos">19</span>					<span class="p">}</span>
<span class="linenos">20</span>					<span class="k">yield</span> <span class="k">return</span> <span class="n">buffer</span><span class="p">;</span>
<span class="linenos">21</span>				<span class="p">}</span>
<span class="linenos">22</span>			<span class="p">}</span>
<span class="linenos">23</span>		<span class="p">}</span>
<span class="linenos">24</span>		
<span class="linenos">25</span>		<span class="n">private</span> <span class="n">IEnumerable</span><span class="o">&lt;</span><span class="n">byte</span><span class="p">[]</span><span class="o">&gt;</span> <span class="n">Compression</span><span class="p">(</span><span class="n">IEnumerable</span><span class="o">&lt;</span><span class="n">byte</span><span class="p">[]</span><span class="o">&gt;</span> <span class="n">readBuffer</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos">26</span>			<span class="n">foreach</span> <span class="p">(</span><span class="n">var</span> <span class="n">buffer</span> <span class="ow">in</span> <span class="n">readBuffer</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos">27</span>				<span class="k">yield</span> <span class="k">return</span> <span class="n">Compress</span> <span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
<span class="linenos">28</span>			<span class="p">}</span>
<span class="linenos">29</span>		<span class="p">}</span>
<span class="linenos">30</span>
<span class="linenos">31</span>		<span class="n">private</span> <span class="n">static</span> <span class="n">byte</span><span class="p">[]</span> <span class="n">Compress</span><span class="p">(</span><span class="n">byte</span><span class="p">[]</span> <span class="n">data</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos">32</span>			<span class="n">var</span> <span class="n">memStream</span> <span class="o">=</span> <span class="n">new</span> <span class="n">MemoryStream</span> <span class="p">();</span>
<span class="linenos">33</span>			<span class="n">using</span><span class="p">(</span><span class="n">var</span> <span class="n">compressionStream</span> <span class="o">=</span> <span class="n">new</span> <span class="n">GZipStream</span><span class="p">(</span><span class="n">memStream</span><span class="p">,</span> <span class="n">CompressionMode</span><span class="o">.</span><span class="n">Compress</span><span class="p">))</span> <span class="p">{</span>
<span class="linenos">34</span>				<span class="n">compressionStream</span><span class="o">.</span><span class="n">Write</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Length</span><span class="p">);</span>
<span class="linenos">35</span>			<span class="p">}</span>
<span class="linenos">36</span>			<span class="k">return</span> <span class="n">memStream</span><span class="o">.</span><span class="n">ToArray</span> <span class="p">();</span>
<span class="linenos">37</span>		<span class="p">}</span>
<span class="linenos">38</span>
<span class="linenos">39</span>		<span class="n">private</span> <span class="n">void</span> <span class="n">FileWriter</span><span class="p">(</span><span class="n">IEnumerable</span><span class="o">&lt;</span><span class="n">byte</span><span class="p">[]</span><span class="o">&gt;</span> <span class="n">compressedBuffer</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos">40</span>			<span class="n">using</span> <span class="p">(</span><span class="n">var</span> <span class="n">stream</span> <span class="o">=</span> <span class="n">new</span> <span class="n">FileStream</span><span class="p">(</span><span class="s2">&quot;file.gz&quot;</span><span class="p">,</span> <span class="n">FileMode</span><span class="o">.</span><span class="n">OpenOrCreate</span><span class="p">,</span> <span class="n">FileAccess</span><span class="o">.</span><span class="n">Write</span><span class="p">))</span> <span class="p">{</span>
<span class="linenos">41</span>				<span class="n">foreach</span> <span class="p">(</span><span class="n">var</span> <span class="n">buffer</span> <span class="ow">in</span> <span class="n">compressedBuffer</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos">42</span>					<span class="n">stream</span><span class="o">.</span><span class="n">Write</span> <span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">buffer</span><span class="o">.</span><span class="n">Length</span><span class="p">);</span>
<span class="linenos">43</span>				<span class="p">}</span>
<span class="linenos">44</span>			<span class="p">}</span>
<span class="linenos">45</span>		<span class="p">}</span>
<span class="linenos">46</span>	<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Helper class - ThreadedList</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span>	public class ThreadedList&lt;T&gt; : IEnumerable&lt;T&gt;
<span class="linenos"> 2</span>	{
<span class="linenos"> 3</span>		private readonly IEnumerable&lt;T&gt; _list;
<span class="linenos"> 4</span>
<span class="linenos"> 5</span>		public ThreadedList (IEnumerable&lt;T&gt; list){
<span class="linenos"> 6</span>			_list = list;
<span class="linenos"> 7</span>		}
<span class="linenos"> 8</span>
<span class="linenos"> 9</span>		public IEnumerator&lt;T&gt; GetEnumerator ()
<span class="linenos">10</span>		{
<span class="linenos">11</span>			return new ThreadedEnumerator&lt;T&gt;(_list.GetEnumerator ());
<span class="linenos">12</span>		}
<span class="linenos">13</span>
<span class="linenos">14</span>		System.Collections.IEnumerator System.Collections.IEnumerable.GetEnumerator ()
<span class="linenos">15</span>		{
<span class="linenos">16</span>			return GetEnumerator ();
<span class="linenos">17</span>		}
<span class="linenos">18</span>
<span class="linenos">19</span>		private class ThreadedEnumerator&lt;S&gt; : IEnumerator&lt;S&gt; {
<span class="linenos">20</span>
<span class="linenos">21</span>			private readonly IEnumerator&lt;S&gt; _enumerator;
<span class="linenos">22</span>			private readonly Queue&lt;S&gt; _queue;
<span class="linenos">23</span>			private const int _maxQueueSize = 10;
<span class="linenos">24</span>			private readonly Thread _thread;
<span class="linenos">25</span>			private volatile bool _keepGoing = true;
<span class="linenos">26</span>			private volatile bool _finishedEnumerating = false;
<span class="linenos">27</span>			private S _current;
<span class="linenos">28</span>
<span class="linenos">29</span>			public ThreadedEnumerator(IEnumerator&lt;S&gt; enumerator) {
<span class="linenos">30</span>				_enumerator = enumerator;
<span class="linenos">31</span>				_thread = new Thread(Enumerate);
<span class="linenos">32</span>				_thread.Start();
<span class="linenos">33</span>			}
<span class="linenos">34</span>
<span class="linenos">35</span>			private void Enumerate() {
<span class="linenos">36</span>				while (_keepGoing) {
<span class="linenos">37</span>					if (_enumerator.MoveNext ()) {
<span class="linenos">38</span>						var current = _enumerator.Current;
<span class="linenos">39</span>						lock (_queue) {
<span class="linenos">40</span>							while (_queue.Count &gt; _maxQueueSize &amp;&amp; _keepGoing) {
<span class="linenos">41</span>								Monitor.Wait (_queue, 100);
<span class="linenos">42</span>							}
<span class="linenos">43</span>							if (_keepGoing) {
<span class="linenos">44</span>								_queue.Enqueue (current);
<span class="linenos">45</span>								Monitor.Pulse (_queue);
<span class="linenos">46</span>							}
<span class="linenos">47</span>						}
<span class="linenos">48</span>					} else {
<span class="linenos">49</span>						break;
<span class="linenos">50</span>					}
<span class="linenos">51</span>				}
<span class="linenos">52</span>				_finishedEnumerating = true;
<span class="linenos">53</span>			}
<span class="linenos">54</span>
<span class="linenos">55</span>			public bool MoveNext ()
<span class="linenos">56</span>			{
<span class="linenos">57</span>				lock (_queue) {
<span class="linenos">58</span>					while (!_finishedEnumerating &amp;&amp; _queue.Count == 0) {
<span class="linenos">59</span>						Monitor.Wait (_queue, 100);
<span class="linenos">60</span>					}
<span class="linenos">61</span>					if (_queue.Count &gt; 0) {
<span class="linenos">62</span>						_current = _queue.Dequeue ();
<span class="linenos">63</span>						Monitor.Pulse (_queue);
<span class="linenos">64</span>						return true;
<span class="linenos">65</span>					} else {
<span class="linenos">66</span>						_current = default(S);
<span class="linenos">67</span>						return false;
<span class="linenos">68</span>					}
<span class="linenos">69</span>				}
<span class="linenos">70</span>			}
<span class="linenos">71</span>
<span class="linenos">72</span>			public void Reset () {
<span class="linenos">73</span>				lock (_queue) {
<span class="linenos">74</span>					lock (_enumerator) {
<span class="linenos">75</span>						_enumerator.Reset ();
<span class="linenos">76</span>						_queue.Clear ();
<span class="linenos">77</span>					}
<span class="linenos">78</span>				}
<span class="linenos">79</span>			}
<span class="linenos">80</span>
<span class="linenos">81</span>			object System.Collections.IEnumerator.Current {
<span class="linenos">82</span>				get { return _current; }
<span class="linenos">83</span>			}
<span class="linenos">84</span>
<span class="linenos">85</span>			public void Dispose () {
<span class="linenos">86</span>				_keepGoing = false;
<span class="linenos">87</span>				_thread.Join ();
<span class="linenos">88</span>			}
<span class="linenos">89</span>
<span class="linenos">90</span>			public S Current {
<span class="linenos">91</span>				get { return _current; }
<span class="linenos">92</span>			}
<span class="linenos">93</span>		}
<span class="linenos">94</span>	}
</pre></div>
</div>
</section>
<section id="mutual-exclusion">
<h2>Mutual Exclusion<a class="headerlink" href="#mutual-exclusion" title="Permalink to this headline"></a></h2>
<ul class="simple">
<li><p>Mutual exclusion is a general problem that applies to both processes and threads.</p></li>
<li><dl class="simple">
<dt>Processes</dt><dd><ul>
<li><p>Occurs with processes that share resources such as shared memory, files, and other resources that must be updated atomically</p></li>
<li><p>When not otherwise shared, the address space of a process is protected against reads/writes by other processes</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>Threads</dt><dd><ul>
<li><p>Because threads share more resources such as having a shared process heap, there are more resources that need to be potentially protected</p></li>
<li><p>Because the address space is shared among threads in one process, cooperation and coordination is required for threads that read from and write to shared data structures</p></li>
</ul>
</dd>
</dl>
</li>
<li><p>When mutual exclusion is achieved, atomic operations on shared data structures are guaranteed to be atomic and not interrupted by other threads.</p></li>
</ul>
</section>
<section id="tools-for-achieving-mutual-exclusion">
<h2>Tools for Achieving Mutual Exclusion<a class="headerlink" href="#tools-for-achieving-mutual-exclusion" title="Permalink to this headline"></a></h2>
<ul class="simple">
<li><dl class="simple">
<dt>Mutex</dt><dd><ul>
<li><p>Has two operations: Lock() and Unlock()</p></li>
<li><p>Has two states: Locked or Unlocked</p></li>
<li><p>A lock can be acquired before entering a critical region and unlock can be called when leaving the critical region</p></li>
<li><p>If all critical regions are covered by a mutex, then mutual exclusion has been achieved and operations can be said to be atomic</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>Semaphore</dt><dd><ul>
<li><p>Has two operations: Up() and Down()</p></li>
<li><p>Has N states: a counter that has a value from 0 - N</p></li>
<li><p>Up() increases the value by 1</p></li>
<li><p>Down() decreases the value by 1</p></li>
<li><p>When the semaphore has a value &gt; 0, then a thread of execution can enter the critical region</p></li>
<li><p>When the semaphore has a value = 0, then a thread is blocked</p></li>
<li><dl class="simple">
<dt>The purpose of a semaphore is used to:</dt><dd><ul>
<li><p>Limit the number of threads that enter a critical region</p></li>
<li><p>Limit the number of items in a queue between two threads working in a pipeline processing pattern.</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>Monitor</dt><dd><ul>
<li><p>Has four operations: Lock(), Unlock(), Pulse(), Wait()</p></li>
<li><p>Allows for more complicated and user-coded conditions for entering critical regions</p></li>
<li><p>The locking semantics are more complicated for the simplest cases, but can express more complicated mutual exclusion cases in simpler ways than can semaphores or mutexes</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>Additional details may be found in the Operating Systems course</dt><dd><ul>
<li><p>Mutual Exclusion - <a class="reference external" href="http://osdi.cs.courseclouds.com/html/mutualexclusion.html">http://osdi.cs.courseclouds.com/html/mutualexclusion.html</a></p></li>
<li><p>Deadlock - <a class="reference external" href="http://osdi.cs.courseclouds.com/html/deadlock.html">http://osdi.cs.courseclouds.com/html/deadlock.html</a></p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</section>
<section id="mutex-example-java">
<h2>Mutex Example/Java<a class="headerlink" href="#mutex-example-java" title="Permalink to this headline"></a></h2>
<p>This code example shows how to implement a classic mutex, a.k.a. a Lock, in Java.</p>
<p>These examples come from <a class="reference external" href="http://hpjpc.googlecode.com">http://hpjpc.googlecode.com</a> by Christopher and Thiruvathukal.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="n">public</span> <span class="k">class</span> <span class="nc">Lock</span> <span class="p">{</span>
<span class="linenos"> 2</span>    <span class="n">protected</span> <span class="n">boolean</span> <span class="n">locked</span><span class="p">;</span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span>    <span class="n">public</span> <span class="n">Lock</span><span class="p">()</span> <span class="p">{</span>
<span class="linenos"> 5</span>        <span class="n">locked</span> <span class="o">=</span> <span class="n">false</span><span class="p">;</span>
<span class="linenos"> 6</span>    <span class="p">}</span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span>    <span class="n">public</span> <span class="n">synchronized</span> <span class="n">void</span> <span class="n">lock</span><span class="p">()</span> <span class="n">throws</span> <span class="n">InterruptedException</span> <span class="p">{</span>
<span class="linenos"> 9</span>        <span class="k">while</span> <span class="p">(</span><span class="n">locked</span><span class="p">)</span>
<span class="linenos">10</span>            <span class="n">wait</span><span class="p">();</span>
<span class="linenos">11</span>        <span class="n">locked</span> <span class="o">=</span> <span class="n">true</span><span class="p">;</span>
<span class="linenos">12</span>    <span class="p">}</span>
<span class="linenos">13</span>
<span class="linenos">14</span>    <span class="n">public</span> <span class="n">synchronized</span> <span class="n">void</span> <span class="n">unlock</span><span class="p">()</span> <span class="p">{</span>
<span class="linenos">15</span>        <span class="n">locked</span> <span class="o">=</span> <span class="n">false</span><span class="p">;</span>
<span class="linenos">16</span>        <span class="n">notify</span><span class="p">();</span>
<span class="linenos">17</span>    <span class="p">}</span>
<span class="linenos">18</span><span class="p">}</span>
</pre></div>
</div>
</section>
<section id="semaphore-example">
<h2>Semaphore Example<a class="headerlink" href="#semaphore-example" title="Permalink to this headline"></a></h2>
<p>This shows how to implement a counting semaphore in the Java programming language.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span>
<span class="linenos"> 2</span><span class="n">public</span> <span class="k">class</span> <span class="nc">Semaphore</span> <span class="p">{</span>
<span class="linenos"> 3</span>    <span class="o">/**</span>
<span class="linenos"> 4</span>     <span class="o">*</span> <span class="n">The</span> <span class="n">current</span> <span class="n">count</span><span class="p">,</span> <span class="n">which</span> <span class="n">must</span> <span class="n">be</span> <span class="n">non</span><span class="o">-</span><span class="n">negative</span><span class="o">.</span>
<span class="linenos"> 5</span>     <span class="o">*/</span>
<span class="linenos"> 6</span>    <span class="n">protected</span> <span class="nb">int</span> <span class="n">count</span><span class="p">;</span>
<span class="linenos"> 7</span>
<span class="linenos"> 8</span>    <span class="o">/**</span>
<span class="linenos"> 9</span>     <span class="o">*</span> <span class="n">Create</span> <span class="n">a</span> <span class="n">counting</span> <span class="n">Semaphore</span> <span class="k">with</span> <span class="n">a</span> <span class="n">specified</span> <span class="n">initial</span> <span class="n">count</span><span class="o">.</span>
<span class="linenos">10</span>     <span class="o">*</span>
<span class="linenos">11</span>     <span class="o">*</span> <span class="nd">@param</span> <span class="n">initCount</span> <span class="n">The</span> <span class="n">initial</span> <span class="n">value</span> <span class="n">of</span> <span class="n">count</span><span class="o">.</span>
<span class="linenos">12</span>     <span class="o">*</span> <span class="nd">@throws</span> <span class="n">com</span><span class="o">.</span><span class="n">toolsofcomputing</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">NegativeSemaphoreException</span> <span class="k">if</span> <span class="n">initCount</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span> <span class="mf">0.</span>
<span class="linenos">13</span>     <span class="o">*/</span>
<span class="linenos">14</span>    <span class="n">public</span> <span class="n">Semaphore</span><span class="p">(</span><span class="nb">int</span> <span class="n">initCount</span><span class="p">)</span> <span class="n">throws</span> <span class="n">NegativeSemaphoreException</span> <span class="p">{</span>
<span class="linenos">15</span>        <span class="k">if</span> <span class="p">(</span><span class="n">initCount</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<span class="linenos">16</span>            <span class="n">throw</span> <span class="n">new</span> <span class="n">NegativeSemaphoreException</span><span class="p">();</span>
<span class="linenos">17</span>        <span class="n">count</span> <span class="o">=</span> <span class="n">initCount</span><span class="p">;</span>
<span class="linenos">18</span>    <span class="p">}</span>
<span class="linenos">19</span>
<span class="linenos">20</span>    <span class="o">/**</span>
<span class="linenos">21</span>     <span class="o">*</span> <span class="n">Create</span> <span class="n">a</span> <span class="n">counting</span> <span class="n">Semaphore</span> <span class="k">with</span> <span class="n">an</span> <span class="n">initial</span> <span class="n">count</span> <span class="n">of</span> <span class="n">zero</span><span class="o">.</span>
<span class="linenos">22</span>     <span class="o">*/</span>
<span class="linenos">23</span>    <span class="n">public</span> <span class="n">Semaphore</span><span class="p">()</span> <span class="p">{</span>
<span class="linenos">24</span>        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="linenos">25</span>    <span class="p">}</span>
<span class="linenos">26</span>
<span class="linenos">27</span>    <span class="o">/**</span>
<span class="linenos">28</span>     <span class="o">*</span> <span class="n">Subtract</span> <span class="n">one</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">count</span><span class="o">.</span> <span class="n">Since</span> <span class="n">count</span> <span class="n">must</span> <span class="n">be</span> <span class="n">non</span><span class="o">-</span><span class="n">negative</span><span class="p">,</span> <span class="n">wait</span> <span class="n">until</span>
<span class="linenos">29</span>     <span class="o">*</span> <span class="n">count</span> <span class="ow">is</span> <span class="n">positive</span> <span class="n">before</span> <span class="n">decrementing</span> <span class="n">it</span><span class="o">.</span>
<span class="linenos">30</span>     <span class="o">*</span>
<span class="linenos">31</span>     <span class="o">*</span> <span class="nd">@throws</span> <span class="n">InterruptedException</span> <span class="k">if</span> <span class="n">thread</span> <span class="ow">is</span> <span class="n">interrupted</span> <span class="k">while</span> <span class="n">waiting</span><span class="o">.</span>
<span class="linenos">32</span>     <span class="o">*/</span>
<span class="linenos">33</span>    <span class="n">public</span> <span class="n">synchronized</span> <span class="n">void</span> <span class="n">down</span><span class="p">()</span> <span class="n">throws</span> <span class="n">InterruptedException</span> <span class="p">{</span>
<span class="linenos">34</span>        <span class="k">while</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<span class="linenos">35</span>            <span class="n">wait</span><span class="p">();</span>
<span class="linenos">36</span>        <span class="n">count</span><span class="o">--</span><span class="p">;</span>
<span class="linenos">37</span>    <span class="p">}</span>
<span class="linenos">38</span>
<span class="linenos">39</span>    <span class="o">/**</span>
<span class="linenos">40</span>     <span class="o">*</span> <span class="n">Add</span> <span class="n">one</span> <span class="n">to</span> <span class="n">the</span> <span class="n">count</span><span class="o">.</span> <span class="n">Wake</span> <span class="n">up</span> <span class="n">a</span> <span class="n">thread</span> <span class="n">waiting</span> <span class="n">to</span> <span class="s2">&quot;down&quot;</span> <span class="n">the</span> <span class="n">semaphore</span><span class="p">,</span> <span class="k">if</span>
<span class="linenos">41</span>     <span class="o">*</span> <span class="nb">any</span><span class="o">.</span>
<span class="linenos">42</span>     <span class="o">*/</span>
<span class="linenos">43</span>    <span class="n">public</span> <span class="n">synchronized</span> <span class="n">void</span> <span class="n">up</span><span class="p">()</span> <span class="p">{</span>
<span class="linenos">44</span>        <span class="n">count</span><span class="o">++</span><span class="p">;</span>
<span class="linenos">45</span>        <span class="n">notify</span><span class="p">();</span>
<span class="linenos">46</span>    <span class="p">}</span>
<span class="linenos">47</span><span class="p">}</span>
<span class="linenos">48</span>
</pre></div>
</div>
</section>
<section id="barrier">
<h2>Barrier<a class="headerlink" href="#barrier" title="Permalink to this headline"></a></h2>
<p>This shows how to implement a barrier, which is a synchronization mechanism for awaiting
a specified number of threads before processing can continue. Once all threads have arrived,
processing can continue.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span>
<span class="linenos"> 2</span><span class="n">public</span> <span class="k">class</span> <span class="nc">SimpleBarrier</span> <span class="p">{</span>
<span class="linenos"> 3</span>    <span class="o">/**</span>
<span class="linenos"> 4</span>     <span class="o">*</span> <span class="n">Number</span> <span class="n">of</span> <span class="n">threads</span> <span class="n">that</span> <span class="n">still</span> <span class="n">must</span> <span class="n">gather</span><span class="o">.</span>
<span class="linenos"> 5</span>     <span class="o">*/</span>
<span class="linenos"> 6</span>    <span class="n">protected</span> <span class="nb">int</span> <span class="n">count</span><span class="p">;</span>
<span class="linenos"> 7</span>    <span class="o">/**</span>
<span class="linenos"> 8</span>     <span class="o">*</span> <span class="n">Total</span> <span class="n">number</span> <span class="n">of</span> <span class="n">threads</span> <span class="n">that</span> <span class="n">must</span> <span class="n">gather</span><span class="o">.</span>
<span class="linenos"> 9</span>     <span class="o">*/</span>
<span class="linenos">10</span>    <span class="n">protected</span> <span class="nb">int</span> <span class="n">initCount</span><span class="p">;</span>
<span class="linenos">11</span>
<span class="linenos">12</span>    <span class="o">/**</span>
<span class="linenos">13</span>     <span class="o">*</span> <span class="n">Creates</span> <span class="n">a</span> <span class="n">Barrier</span> <span class="n">at</span> <span class="n">which</span> <span class="n">n</span> <span class="n">threads</span> <span class="n">may</span> <span class="n">repeatedly</span> <span class="n">gather</span><span class="o">.</span>
<span class="linenos">14</span>     <span class="o">*</span>
<span class="linenos">15</span>     <span class="o">*</span> <span class="nd">@param</span> <span class="n">n</span> <span class="n">total</span> <span class="n">number</span> <span class="n">of</span> <span class="n">threads</span> <span class="n">that</span> <span class="n">must</span> <span class="n">gather</span><span class="o">.</span>
<span class="linenos">16</span>     <span class="o">*/</span>
<span class="linenos">17</span>
<span class="linenos">18</span>    <span class="n">public</span> <span class="n">SimpleBarrier</span><span class="p">(</span><span class="nb">int</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos">19</span>        <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
<span class="linenos">20</span>            <span class="n">throw</span> <span class="n">new</span> <span class="n">IllegalArgumentException</span><span class="p">(</span>
<span class="linenos">21</span>                    <span class="s2">&quot;Barrier initialization specified non-positive value &quot;</span> <span class="o">+</span> <span class="n">n</span><span class="p">);</span>
<span class="linenos">22</span>        <span class="n">initCount</span> <span class="o">=</span> <span class="n">count</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
<span class="linenos">23</span>    <span class="p">}</span>
<span class="linenos">24</span>
<span class="linenos">25</span>    <span class="o">/**</span>
<span class="linenos">26</span>     <span class="o">*</span> <span class="n">Is</span> <span class="n">called</span> <span class="n">by</span> <span class="n">a</span> <span class="n">thread</span> <span class="n">to</span> <span class="n">wait</span> <span class="k">for</span> <span class="n">the</span> <span class="n">rest</span> <span class="n">of</span> <span class="n">the</span> <span class="n">n</span> <span class="n">threads</span> <span class="n">to</span> <span class="n">gather</span>
<span class="linenos">27</span>     <span class="o">*</span> <span class="n">before</span> <span class="n">the</span> <span class="nb">set</span> <span class="n">of</span> <span class="n">threads</span> <span class="n">may</span> <span class="k">continue</span> <span class="n">executing</span><span class="o">.</span>
<span class="linenos">28</span>     <span class="o">*</span>
<span class="linenos">29</span>     <span class="o">*</span> <span class="nd">@throws</span> <span class="n">InterruptedException</span> <span class="n">If</span> <span class="n">interrupted</span> <span class="k">while</span> <span class="n">waiting</span><span class="o">.</span>
<span class="linenos">30</span>     <span class="o">*/</span>
<span class="linenos">31</span>    <span class="n">public</span> <span class="n">synchronized</span> <span class="n">void</span> <span class="n">gather</span><span class="p">()</span> <span class="n">throws</span> <span class="n">InterruptedException</span> <span class="p">{</span>
<span class="linenos">32</span>        <span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
<span class="linenos">33</span>            <span class="n">wait</span><span class="p">();</span>
<span class="linenos">34</span>        <span class="k">else</span> <span class="p">{</span>
<span class="linenos">35</span>            <span class="n">count</span> <span class="o">=</span> <span class="n">initCount</span><span class="p">;</span>
<span class="linenos">36</span>            <span class="n">notifyAll</span><span class="p">();</span>
<span class="linenos">37</span>        <span class="p">}</span>
<span class="linenos">38</span>    <span class="p">}</span>
<span class="linenos">39</span><span class="p">}</span>
<span class="linenos">40</span>
</pre></div>
</div>
</section>
<section id="deadlock-a-classic-problem">
<h2>Deadlock - a classic problem<a class="headerlink" href="#deadlock-a-classic-problem" title="Permalink to this headline"></a></h2>
<p>A classic problem in computer science and one that is often studied in operating systems
to show the hazards of working with shared, synchronized state, is the <em>dining philosophers problem</em>.
We won’t describe the entire problem here but you can read <a class="reference external" href="http://en.wikipedia.org/wiki/Dining_philosophers_problem">http://en.wikipedia.org/wiki/Dining_philosophers_problem</a>.</p>
<p>our “solution” has the following design:</p>
<ul class="simple">
<li><p>Fork: A class to represent the forks shared by adjacent philosophers at the table.</p></li>
<li><p>Diner0: A class used to represent a philosopher. The philosopher does three things a philosopher normally does: think(), sleep(), and eat().</p></li>
<li><p>Diners0: A class used to represent all of the diners seated at the table with their shared forks. This is where the concurrency takes place.</p></li>
</ul>
</section>
<section id="fork">
<h2>Fork<a class="headerlink" href="#fork" title="Permalink to this headline"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="n">public</span> <span class="k">class</span> <span class="nc">Fork</span> <span class="p">{</span>
<span class="linenos"> 2</span>    <span class="n">public</span> <span class="n">char</span> <span class="nb">id</span><span class="p">;</span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span>    <span class="n">private</span> <span class="n">Lock</span> <span class="n">lock</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Lock</span><span class="p">();</span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span>    <span class="n">public</span> <span class="n">Fork</span><span class="p">(</span><span class="nb">int</span> <span class="n">value</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos"> 7</span>        <span class="n">this</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Integer</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">toString</span><span class="p">()</span><span class="o">.</span><span class="n">charAt</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="linenos"> 8</span>    <span class="p">}</span>
<span class="linenos"> 9</span>
<span class="linenos">10</span>    <span class="n">public</span> <span class="n">void</span> <span class="n">pickup</span><span class="p">()</span> <span class="n">throws</span> <span class="n">InterruptedException</span> <span class="p">{</span>
<span class="linenos">11</span>        <span class="n">lock</span><span class="o">.</span><span class="n">lock</span><span class="p">();</span>
<span class="linenos">12</span>    <span class="p">}</span>
<span class="linenos">13</span>
<span class="linenos">14</span>    <span class="n">public</span> <span class="n">void</span> <span class="n">putdown</span><span class="p">()</span> <span class="n">throws</span> <span class="n">InterruptedException</span> <span class="p">{</span>
<span class="linenos">15</span>        <span class="n">lock</span><span class="o">.</span><span class="n">unlock</span><span class="p">();</span>
<span class="linenos">16</span>    <span class="p">}</span>
<span class="linenos">17</span><span class="p">}</span>
</pre></div>
</div>
</section>
<section id="diner0">
<h2>Diner0<a class="headerlink" href="#diner0" title="Permalink to this headline"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="n">public</span> <span class="k">class</span> <span class="nc">Diner0</span> <span class="n">extends</span> <span class="n">Thread</span> <span class="p">{</span>
<span class="linenos"> 2</span>    <span class="n">private</span> <span class="n">char</span> <span class="n">state</span> <span class="o">=</span> <span class="s1">&#39;t&#39;</span><span class="p">;</span>
<span class="linenos"> 3</span>    <span class="n">private</span> <span class="n">Fork</span> <span class="n">L</span><span class="p">,</span> <span class="n">R</span><span class="p">;</span>
<span class="linenos"> 4</span>
<span class="linenos"> 5</span>    <span class="n">public</span> <span class="n">Diner0</span><span class="p">(</span><span class="n">Fork</span> <span class="n">left</span><span class="p">,</span> <span class="n">Fork</span> <span class="n">right</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos"> 6</span>        <span class="nb">super</span><span class="p">();</span>
<span class="linenos"> 7</span>        <span class="n">L</span> <span class="o">=</span> <span class="n">left</span><span class="p">;</span>
<span class="linenos"> 8</span>        <span class="n">R</span> <span class="o">=</span> <span class="n">right</span><span class="p">;</span>
<span class="linenos"> 9</span>    <span class="p">}</span>
<span class="linenos">10</span>
<span class="linenos">11</span>    <span class="n">protected</span> <span class="n">void</span> <span class="n">think</span><span class="p">()</span> <span class="n">throws</span> <span class="n">InterruptedException</span> <span class="p">{</span>
<span class="linenos">12</span>        <span class="n">sleep</span><span class="p">((</span><span class="n">long</span><span class="p">)</span> <span class="p">(</span><span class="n">Math</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">*</span> <span class="mf">7.0</span><span class="p">));</span>
<span class="linenos">13</span>    <span class="p">}</span>
<span class="linenos">14</span>
<span class="linenos">15</span>    <span class="n">protected</span> <span class="n">void</span> <span class="n">eat</span><span class="p">()</span> <span class="n">throws</span> <span class="n">InterruptedException</span> <span class="p">{</span>
<span class="linenos">16</span>        <span class="n">sleep</span><span class="p">((</span><span class="n">long</span><span class="p">)</span> <span class="p">(</span><span class="n">Math</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">*</span> <span class="mf">7.0</span><span class="p">));</span>
<span class="linenos">17</span>    <span class="p">}</span>
<span class="linenos">18</span>
<span class="linenos">19</span>    <span class="n">public</span> <span class="n">char</span> <span class="n">getDinerState</span><span class="p">()</span> <span class="p">{</span>
<span class="linenos">20</span>        <span class="k">return</span> <span class="n">state</span><span class="p">;</span>
<span class="linenos">21</span>    <span class="p">}</span>
<span class="linenos">22</span>
<span class="linenos">23</span>    <span class="n">public</span> <span class="n">void</span> <span class="n">run</span><span class="p">()</span> <span class="p">{</span>
<span class="linenos">24</span>        <span class="nb">int</span> <span class="n">i</span><span class="p">;</span>
<span class="linenos">25</span>
<span class="linenos">26</span>        <span class="k">try</span> <span class="p">{</span>
<span class="linenos">27</span>            <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos">28</span>                <span class="n">state</span> <span class="o">=</span> <span class="s1">&#39;t&#39;</span><span class="p">;</span>
<span class="linenos">29</span>                <span class="n">think</span><span class="p">();</span>
<span class="linenos">30</span>                <span class="n">state</span> <span class="o">=</span> <span class="n">L</span><span class="o">.</span><span class="n">id</span><span class="p">;</span>
<span class="linenos">31</span>                <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="linenos">32</span>                <span class="n">L</span><span class="o">.</span><span class="n">pickup</span><span class="p">();</span>
<span class="linenos">33</span>                <span class="n">state</span> <span class="o">=</span> <span class="n">R</span><span class="o">.</span><span class="n">id</span><span class="p">;</span>
<span class="linenos">34</span>                <span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="linenos">35</span>                <span class="n">R</span><span class="o">.</span><span class="n">pickup</span><span class="p">();</span>
<span class="linenos">36</span>                <span class="n">state</span> <span class="o">=</span> <span class="s1">&#39;e&#39;</span><span class="p">;</span>
<span class="linenos">37</span>                <span class="n">eat</span><span class="p">();</span>
<span class="linenos">38</span>                <span class="n">L</span><span class="o">.</span><span class="n">putdown</span><span class="p">();</span>
<span class="linenos">39</span>                <span class="n">R</span><span class="o">.</span><span class="n">putdown</span><span class="p">();</span>
<span class="linenos">40</span>            <span class="p">}</span>
<span class="linenos">41</span>            <span class="n">state</span> <span class="o">=</span> <span class="s1">&#39;d&#39;</span><span class="p">;</span>
<span class="linenos">42</span>        <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos">43</span>        <span class="p">}</span>
<span class="linenos">44</span>    <span class="p">}</span>
<span class="linenos">45</span><span class="p">}</span>
</pre></div>
</div>
</section>
<section id="diners0">
<h2>Diners0<a class="headerlink" href="#diners0" title="Permalink to this headline"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="n">public</span> <span class="k">class</span> <span class="nc">Diners0</span> <span class="p">{</span>
<span class="linenos"> 2</span>    <span class="n">private</span> <span class="n">static</span> <span class="n">Fork</span><span class="p">[]</span> <span class="n">fork</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Fork</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
<span class="linenos"> 3</span>    <span class="n">private</span> <span class="n">static</span> <span class="n">Diner0</span><span class="p">[]</span> <span class="n">diner</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Diner0</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
<span class="linenos"> 4</span>
<span class="linenos"> 5</span>    <span class="n">public</span> <span class="n">static</span> <span class="n">void</span> <span class="n">main</span><span class="p">(</span><span class="n">String</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos"> 6</span>        <span class="nb">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="linenos"> 7</span>        <span class="n">boolean</span> <span class="n">goOn</span><span class="p">;</span>
<span class="linenos"> 8</span>
<span class="linenos"> 9</span>        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos">10</span>            <span class="n">fork</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Fork</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<span class="linenos">11</span>        <span class="p">}</span>
<span class="linenos">12</span>
<span class="linenos">13</span>        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos">14</span>            <span class="n">diner</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Diner0</span><span class="p">(</span><span class="n">fork</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">fork</span><span class="p">[(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">5</span><span class="p">]);</span>
<span class="linenos">15</span>        <span class="p">}</span>
<span class="linenos">16</span>
<span class="linenos">17</span>        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos">18</span>            <span class="n">diner</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">start</span><span class="p">();</span>
<span class="linenos">19</span>        <span class="p">}</span>
<span class="linenos">20</span>
<span class="linenos">21</span>        <span class="nb">int</span> <span class="n">newPrio</span> <span class="o">=</span> <span class="n">Thread</span><span class="o">.</span><span class="n">currentThread</span><span class="p">()</span><span class="o">.</span><span class="n">getPriority</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="linenos">22</span>
<span class="linenos">23</span>        <span class="n">Thread</span><span class="o">.</span><span class="n">currentThread</span><span class="p">()</span><span class="o">.</span><span class="n">setPriority</span><span class="p">(</span><span class="n">newPrio</span><span class="p">);</span>
<span class="linenos">24</span>
<span class="linenos">25</span>        <span class="n">goOn</span> <span class="o">=</span> <span class="n">true</span><span class="p">;</span>
<span class="linenos">26</span>
<span class="linenos">27</span>        <span class="k">while</span> <span class="p">(</span><span class="n">goOn</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos">28</span>            <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos">29</span>                <span class="n">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="n">diner</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getDinerState</span><span class="p">());</span>
<span class="linenos">30</span>            <span class="p">}</span>
<span class="linenos">31</span>
<span class="linenos">32</span>            <span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">j</span> <span class="o">%</span> <span class="mi">5</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<span class="linenos">33</span>                <span class="n">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="p">();</span>
<span class="linenos">34</span>            <span class="k">else</span>
<span class="linenos">35</span>                <span class="n">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">);</span>
<span class="linenos">36</span>
<span class="linenos">37</span>            <span class="n">goOn</span> <span class="o">=</span> <span class="n">false</span><span class="p">;</span>
<span class="linenos">38</span>
<span class="linenos">39</span>            <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos">40</span>                <span class="n">goOn</span> <span class="o">|=</span> <span class="n">diner</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">getDinerState</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;d&#39;</span><span class="p">;</span>
<span class="linenos">41</span>            <span class="p">}</span>
<span class="linenos">42</span>
<span class="linenos">43</span>            <span class="k">try</span> <span class="p">{</span>
<span class="linenos">44</span>                <span class="n">Thread</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">51</span><span class="p">);</span>
<span class="linenos">45</span>            <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos">46</span>                <span class="k">return</span><span class="p">;</span>
<span class="linenos">47</span>            <span class="p">}</span>
<span class="linenos">48</span>        <span class="p">}</span>
<span class="linenos">49</span>    <span class="p">}</span>
<span class="linenos">50</span><span class="p">}</span>
</pre></div>
</div>
</section>
<section id="diners1-eliminating-deadlock-with-resource-enumeration">
<h2>Diners1 - eliminating deadlock with resource enumeration<a class="headerlink" href="#diners1-eliminating-deadlock-with-resource-enumeration" title="Permalink to this headline"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span>        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos">2</span>            <span class="n">diner</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Diner0</span><span class="p">(</span><span class="n">fork</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">fork</span><span class="p">[(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">5</span><span class="p">]);</span>
<span class="linenos">3</span>        <span class="p">}</span>
<span class="linenos">4</span>        <span class="n">diner</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Diner0</span><span class="p">(</span><span class="n">fork</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fork</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
</pre></div>
</div>
</section>
<section id="execution-with-deadlock">
<h2>Execution - With Deadlock<a class="headerlink" href="#execution-with-deadlock" title="Permalink to this headline"></a></h2>
<p>If you have Java and Gradle installed on your computer, you can try these out!</p>
<p>Make sure you have the HPJPC source code:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">hg</span> <span class="n">clone</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">bitbucket</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">loyolachicagocs_books</span><span class="o">/</span><span class="n">hpjpc</span><span class="o">-</span><span class="n">source</span><span class="o">-</span><span class="n">java</span>
</pre></div>
</div>
<p>The following Gradle task in <code class="docutils literal notranslate"><span class="pre">build.gradle</span></code> shows how to run Diners0’s <code class="docutils literal notranslate"><span class="pre">main()</span></code> method:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="n">task</span> <span class="n">Diners0</span><span class="p">(</span><span class="n">dependsOn</span><span class="p">:</span> <span class="s1">&#39;classes&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="p">:</span> <span class="n">JavaExec</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos">2</span>    <span class="n">main</span> <span class="o">=</span> <span class="s1">&#39;info.jhpc.textbook.chapter03.Diners0&#39;</span>
<span class="linenos">3</span>    <span class="n">classpath</span> <span class="o">=</span> <span class="n">sourceSets</span><span class="o">.</span><span class="n">main</span><span class="o">.</span><span class="n">runtimeClasspath</span>
<span class="linenos">4</span>    <span class="n">args</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">5</span><span class="p">}</span>
</pre></div>
</div>
<p>To build:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gradle</span> <span class="n">build</span>
</pre></div>
</div>
<p>To run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gradle</span> <span class="n">Diners0</span>
</pre></div>
</div>
<p>If you run this, you will notice that deadlock ensues fairly quick. The diners get
into a state where they are waiting on each others’ forks in a cycle:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ gradle Diners0
:compileJava UP-TO-DATE
:processResources UP-TO-DATE
:classes UP-TO-DATE
:Diners0
tet4t 023et 12ett 0et40 e134e
et340 12ett 12ett 123et e1340
0234e e23e4 1tt40 t23et ett40
t23et 1ett0 12et0 t23et 1tt40
1t34e 12et0 1et40 12e30 t234e
12e30 1et40 tetet et3t4 1t3e4
1e240 1tte4 12tt0 t2ete t2tt0
11e3t et3t0 t234e e1340 11t40
1t340 0e24e tttet tt34e 12e3t
1t24e 0t3e4 tet4e 12340 12340
12340 12340 12340 12340 12340
12340 12340 12340 12340 12340
12340 12340 12340 12340 12340
12340 12340 12340 12340 12340
12340 12340 12340 12340 12340
12340 12340 12340 12340 12340
12340 12340 12340 12340 12340
12340 12340 12340 12340 12340
12340 12340 12340 12340 12340
12340 12340 12340 12340 12340
12340 12340 12340 12340 12340
12340 12340 12340 12340 12340
12340 12340 12340 12340 12340
12340 12340 12340 12340 12340
12340 12340 12340 12340 12340
</pre></div>
</div>
</section>
<section id="deadlock-free-version">
<h2>Deadlock-Free Version<a class="headerlink" href="#deadlock-free-version" title="Permalink to this headline"></a></h2>
<p>Diners1 has a similar Gradle task:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="n">task</span> <span class="n">Diners1</span><span class="p">(</span><span class="n">dependsOn</span><span class="p">:</span> <span class="s1">&#39;classes&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="p">:</span> <span class="n">JavaExec</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos">2</span>    <span class="n">main</span> <span class="o">=</span> <span class="s1">&#39;info.jhpc.textbook.chapter03.Diners1&#39;</span>
<span class="linenos">3</span>    <span class="n">classpath</span> <span class="o">=</span> <span class="n">sourceSets</span><span class="o">.</span><span class="n">main</span><span class="o">.</span><span class="n">runtimeClasspath</span>
<span class="linenos">4</span>    <span class="n">args</span> <span class="o">=</span> <span class="p">[]</span>
<span class="linenos">5</span><span class="p">}</span>
<span class="linenos">6</span>
</pre></div>
</div>
<p>Run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gradle</span> <span class="n">Diners1</span>
</pre></div>
</div>
<p>Output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ gradle Diners1
:compileJava UP-TO-DATE
:processResources UP-TO-DATE
:classes UP-TO-DATE
:Diners1
ttttt 1t240 t2et4 1et4t tt2e4
1e2et 1et4t e13e0 tt3e4 ettt0
t2te0 0e24e 1ettt e1e3t t1te4
0tt4e 1etet e13tt tt24e 1t3et
tettt 0ttet ete3t tt33e 0et4e
1ete0 01t3t 0tt3e 1e240 te2te
e1et0 1e2et 02e3e t1t3t 1t3tt
02ete 1et4t e13et et33t 02tte
1ett0 et3t0 ete30 t2e3e et3e0
0et4e ettt0 0e2e4 01t4e 1e2et
...
12e30 tet3e 1etet 0ttt0 0etet
1et4t e2tt4 tt3e4 0t3et 12et0
1ett0 e1tet 12e30 1tttt etet0
tettt 1e2t0 0t3e4 tettt ttttt
023e4 ttttt 023e4 1e2d0 e13d0
02ed4 e2edt 1etd0 et3d0 1tedt
02ede 0etde 1etd0 t2tdt t2ede
01tde et2d0 112dt tedde tedd4
tedde 02dd0 1edd0 etdd0 1tddt
1eddt 1eddt 01dde 0tdd0 t2dde
t2ddt eddd4 tddde tddd4 tdddt
0ddde eddd0 tdddt 0ddde eddd0
tddd4 eddd0 0ddde 0ddde eddd0
eddd0 0ddde 0ddde tddd4 0dddt
eddd0 tddd4 1dddd 0dddd 1dddd
tdddd tdddd ddddd
BUILD SUCCESSFUL

Total time: 18.426 secs
</pre></div>
</div>
<p>The diners, as desired, end up finishing their meal after some time.</p>
<p>We assume they have moved over to the bar or found a nice place to have dessert.</p>
</section>
<section id="common-data-structures-in-concurrent-programming">
<h2>Common Data Structures in Concurrent Programming<a class="headerlink" href="#common-data-structures-in-concurrent-programming" title="Permalink to this headline"></a></h2>
<ul>
<li><dl>
<dt>Bound Buffer</dt><dd><ul class="simple">
<li><p>Makes use of a mutex and semaphore internally</p></li>
<li><p>Defines a maximum number of items that exist in the bound buffer’s queue.</p></li>
<li><p>Has two operations: Enqueue() and Dequeue()</p></li>
<li><p>Enqueue() - enqueues items in the data structure. If the enqueue operation would cause the bound buffer to exceed the maximum, the Enqueue() call will block until another thread dequeues at least one item.</p></li>
<li><p>Dequeue() - dequeues an item from the data structure. If there are zero items in the queue, Dequeue() will block until another thread enqueues an item in the data structure</p></li>
<li><p>Bound buffers are used to make sure that when one thread is producing work for a second thread, that if one thread is faster or slower than the other, that they appropriately wait to some extent for each other.</p></li>
</ul>
<figure class="align-center">
<img alt="Bound Buffer" src="../_images/bound_buffer.png" />
</figure>
</dd>
</dl>
</li>
<li><p>Example Bound Buffer</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span>	<span class="n">public</span> <span class="k">class</span> <span class="nc">BoundBuffer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">{</span>
<span class="linenos"> 2</span>		<span class="n">private</span> <span class="n">readonly</span> <span class="n">Semaphore</span> <span class="n">_full</span><span class="p">;</span>
<span class="linenos"> 3</span>		<span class="n">private</span> <span class="n">readonly</span> <span class="n">Semaphore</span> <span class="n">_empty</span><span class="p">;</span>
<span class="linenos"> 4</span>		<span class="n">private</span> <span class="n">readonly</span> <span class="n">Semaphore</span> <span class="n">_lock</span><span class="p">;</span>
<span class="linenos"> 5</span>		<span class="n">private</span> <span class="n">readonly</span> <span class="n">Queue</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">_queue</span><span class="p">;</span>
<span class="linenos"> 6</span>
<span class="linenos"> 7</span>		<span class="n">public</span> <span class="n">BoundBuffer</span> <span class="p">(</span><span class="nb">int</span> <span class="n">maxCount</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos"> 8</span>			<span class="n">_empty</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Semaphore</span> <span class="p">(</span><span class="n">maxCount</span><span class="p">,</span> <span class="n">maxCount</span><span class="p">);</span>
<span class="linenos"> 9</span>			<span class="n">_full</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Semaphore</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">maxCount</span><span class="p">);</span>
<span class="linenos">10</span>			<span class="n">_lock</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Semaphore</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="linenos">11</span>			<span class="n">_queue</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Queue</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="p">();</span>
<span class="linenos">12</span>		<span class="p">}</span>
<span class="linenos">13</span>
<span class="linenos">14</span>		<span class="n">public</span> <span class="n">void</span> <span class="n">Enqueue</span><span class="p">(</span><span class="n">T</span> <span class="n">item</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos">15</span>			<span class="n">_empty</span><span class="o">.</span><span class="n">WaitOne</span> <span class="p">();</span>
<span class="linenos">16</span>			<span class="n">_lock</span><span class="o">.</span><span class="n">WaitOne</span> <span class="p">();</span>
<span class="linenos">17</span>			<span class="n">_queue</span><span class="o">.</span><span class="n">Enqueue</span> <span class="p">(</span><span class="n">item</span><span class="p">);</span>
<span class="linenos">18</span>			<span class="n">_lock</span><span class="o">.</span><span class="n">Release</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="linenos">19</span>			<span class="n">_full</span><span class="o">.</span><span class="n">Release</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="linenos">20</span>		<span class="p">}</span>
<span class="linenos">21</span>
<span class="linenos">22</span>		<span class="n">public</span> <span class="n">T</span> <span class="n">Dequeue</span><span class="p">()</span> <span class="p">{</span>
<span class="linenos">23</span>			<span class="n">_full</span><span class="o">.</span><span class="n">WaitOne</span> <span class="p">();</span>
<span class="linenos">24</span>			<span class="n">_lock</span><span class="o">.</span><span class="n">WaitOne</span> <span class="p">();</span>
<span class="linenos">25</span>			<span class="n">var</span> <span class="n">item</span> <span class="o">=</span> <span class="n">_queue</span><span class="o">.</span><span class="n">Dequeue</span> <span class="p">();</span>
<span class="linenos">26</span>			<span class="n">_lock</span><span class="o">.</span><span class="n">Release</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="linenos">27</span>			<span class="n">_empty</span><span class="o">.</span><span class="n">Release</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="linenos">28</span>			<span class="k">return</span> <span class="n">item</span><span class="p">;</span>
<span class="linenos">29</span>		<span class="p">}</span>
<span class="linenos">30</span>	<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="design-considerations">
<h2>Design Considerations<a class="headerlink" href="#design-considerations" title="Permalink to this headline"></a></h2>
<ul class="simple">
<li><dl class="simple">
<dt>Threading requires the support of the operating system - a threading library / package is needed</dt><dd><ul>
<li><p>In Windows, this is a part of the Windows SDK and .NET Framework</p></li>
<li><p>In Linux and Mac OSX, PThreads provides threading</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>Thread usage and creation</dt><dd><ul>
<li><p>Threads can be started and stopped on demand or a thread pool can be used</p></li>
<li><dl class="simple">
<dt>Starting threads dynamically:</dt><dd><ul>
<li><p>Has some cost associated with asking the OS to create and schedule the thread</p></li>
<li><p>It can be architecturally challenging to maintain an appropriate number of threads across software components</p></li>
<li><p>This is overall the most simple approach</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>Thread Pools</dt><dd><ul>
<li><p>The number of threads can be defined at compile time or when the program is first launched</p></li>
<li><p>Instead of creating a new thread, the program acquires a thread and passes a function pointer to the thread to execute</p></li>
<li><p>When the given task is completed, the thread is returned to the pool.</p></li>
<li><p>This approach does not have the overhead of creating / destroying threads as threads are reused.</p></li>
<li><p>This approach often requires library support or some additional code.</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>The total number of threads</dt><dd><ul>
<li><p>Having several hundred threads on a system with an order of magnitude fewer cores can cause you to run into trouble.</p></li>
<li><p>If a majority of those threads are runnable, then the program will spend most of its time context switching between those threads rather than actually getting work done.</p></li>
<li><p>If such a system is dynamically starting and stopping threads, then the program will most likely spend most of its time creating and destroying threads.</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</section>
<section id="kernel-threads-vs-user-mode-threads">
<h2>Kernel Threads vs User Mode Threads<a class="headerlink" href="#kernel-threads-vs-user-mode-threads" title="Permalink to this headline"></a></h2>
<ul>
<li><dl>
<dt>There are two types of threads:</dt><dd><ul class="simple">
<li><dl class="simple">
<dt>Kernel Threads</dt><dd><p>-Supported by modern operating systems
-Scheduled by the operating system</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>User Threads</dt><dd><p>-Supported by almost everything
-Scheduled by the process</p>
</dd>
</dl>
</li>
</ul>
<figure class="align-center">
<img alt="Kernel and User Mode Threads" src="../_images/kernel_user_threads.png" />
</figure>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>Context switching:</dt><dd><ul class="simple">
<li><p>Kernel threads have a higher overhead because the scheduler must be invoked and there might be a time lag before a runnable thread is actually executed.</p></li>
<li><p>Kernel threads often perform very well because the operating system has more information about the resource state of the computer and can make better global scheduling decisions than can a program</p></li>
<li><p>User-mode threads can context switch with fewer overall operations, but scheduling them is guess-work.</p></li>
<li><p>User mode threads can be created more rapidly because new stacks and scheduler entries do not need to be created by the operating system</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>Where are user-mode threads used?</dt><dd><ul class="simple">
<li><p>In systems without kernel mode threads</p></li>
<li><p>When the number of threads a system needs is in the hundreds or thousands (user-mode threads scale better in these scenarios)</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>Where are kernel-mode threads used?</dt><dd><ul class="simple">
<li><p>When the number of threads is not very high (less than 10 per core)</p></li>
<li><p>When blocking calls are involved (user-mode thread libraries usually have separate I/O libraries)</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</section>
<section id="concurrent-file-copy-example">
<h2>Concurrent File Copy Example<a class="headerlink" href="#concurrent-file-copy-example" title="Permalink to this headline"></a></h2>
<ul class="simple">
<li><p>FileCopy0: The sequential version</p></li>
<li><p>FileCopy1: The concurrent version</p></li>
</ul>
</section>
<section id="sequential-file-copy">
<h2>Sequential File Copy<a class="headerlink" href="#sequential-file-copy" title="Permalink to this headline"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="n">public</span> <span class="k">class</span> <span class="nc">FileCopy0</span> <span class="p">{</span>
<span class="linenos"> 2</span>    <span class="n">public</span> <span class="n">static</span> <span class="n">final</span> <span class="nb">int</span> <span class="n">BLOCK_SIZE</span> <span class="o">=</span> <span class="mi">4096</span><span class="p">;</span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span>    <span class="n">public</span> <span class="n">static</span> <span class="n">void</span> <span class="n">copy</span><span class="p">(</span><span class="n">String</span> <span class="n">src</span><span class="p">,</span> <span class="n">String</span> <span class="n">dst</span><span class="p">)</span> <span class="n">throws</span> <span class="n">IOException</span> <span class="p">{</span>
<span class="linenos"> 5</span>        <span class="n">FileReader</span> <span class="n">fr</span> <span class="o">=</span> <span class="n">new</span> <span class="n">FileReader</span><span class="p">(</span><span class="n">src</span><span class="p">);</span>
<span class="linenos"> 6</span>        <span class="n">FileWriter</span> <span class="n">fw</span> <span class="o">=</span> <span class="n">new</span> <span class="n">FileWriter</span><span class="p">(</span><span class="n">dst</span><span class="p">);</span>
<span class="linenos"> 7</span>        <span class="n">char</span><span class="p">[]</span> <span class="n">buffer</span> <span class="o">=</span> <span class="n">new</span> <span class="n">char</span><span class="p">[</span><span class="n">BLOCK_SIZE</span><span class="p">];</span>
<span class="linenos"> 8</span>        <span class="nb">int</span> <span class="n">bytesRead</span><span class="p">;</span>
<span class="linenos"> 9</span>        <span class="k">while</span> <span class="p">(</span><span class="n">true</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos">10</span>            <span class="n">bytesRead</span> <span class="o">=</span> <span class="n">fr</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
<span class="linenos">11</span>            <span class="n">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="n">bytesRead</span> <span class="o">+</span> <span class="s2">&quot; bytes read&quot;</span><span class="p">);</span>
<span class="linenos">12</span>            <span class="k">if</span> <span class="p">(</span><span class="n">bytesRead</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
<span class="linenos">13</span>                <span class="k">break</span><span class="p">;</span>
<span class="linenos">14</span>            <span class="n">fw</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bytesRead</span><span class="p">);</span>
<span class="linenos">15</span>            <span class="n">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="n">bytesRead</span> <span class="o">+</span> <span class="s2">&quot; bytes written&quot;</span><span class="p">);</span>
<span class="linenos">16</span>
<span class="linenos">17</span>        <span class="p">}</span>
<span class="linenos">18</span>        <span class="n">fw</span><span class="o">.</span><span class="n">close</span><span class="p">();</span>
<span class="linenos">19</span>        <span class="n">fr</span><span class="o">.</span><span class="n">close</span><span class="p">();</span>
<span class="linenos">20</span>    <span class="p">}</span>
<span class="linenos">21</span>
<span class="linenos">22</span>    <span class="n">public</span> <span class="n">static</span> <span class="n">void</span> <span class="n">main</span><span class="p">(</span><span class="n">String</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos">23</span>        <span class="n">String</span> <span class="n">srcFile</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="linenos">24</span>        <span class="n">String</span> <span class="n">dstFile</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="linenos">25</span>        <span class="k">try</span> <span class="p">{</span>
<span class="linenos">26</span>            <span class="n">copy</span><span class="p">(</span><span class="n">srcFile</span><span class="p">,</span> <span class="n">dstFile</span><span class="p">);</span>
<span class="linenos">27</span>        <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="ne">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos">28</span>            <span class="n">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="s2">&quot;Copy failed.&quot;</span><span class="p">);</span>
<span class="linenos">29</span>        <span class="p">}</span>
<span class="linenos">30</span>    <span class="p">}</span>
<span class="linenos">31</span><span class="p">}</span>
</pre></div>
</div>
</section>
<section id="concurrent-file-copy-organization">
<h2>Concurrent File Copy Organization<a class="headerlink" href="#concurrent-file-copy-organization" title="Permalink to this headline"></a></h2>
<p>Quick overview of the various classes:</p>
<ul class="simple">
<li><p>Pool: Maintains a list of buffers that can be used for allocating/freeing blocks of data without triggering new (or dispose) repeatedly.</p></li>
<li><p>Buffer: Used as a shared object for reading and writing blocks of data (via the FileCopyReader1 and FileCopyWriter1 classes)</p></li>
<li><p>BufferQueue: Used to queue up blocks as they are read or written. This allows for varying speeds of reader and writer, subject to the number of blocks available in the Pool.</p></li>
<li><p>FileCopyReader1: Used to run the reader thread.</p></li>
<li><p>FileCopyWriter1: Used to run the writer thread.</p></li>
<li><p>FileCopy1: Used to act as a drop in replacement for FileCopy0. Sets up the reader and writer threads and then joins with both when the reading/writing are completed.</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="n">public</span> <span class="k">class</span> <span class="nc">FileCopy1</span> <span class="p">{</span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span>    <span class="n">public</span> <span class="n">static</span> <span class="nb">int</span> <span class="n">getIntProp</span><span class="p">(</span><span class="n">Properties</span> <span class="n">p</span><span class="p">,</span> <span class="n">String</span> <span class="n">key</span><span class="p">,</span> <span class="nb">int</span> <span class="n">defaultValue</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos"> 4</span>
<span class="linenos"> 5</span>        <span class="k">try</span> <span class="p">{</span>
<span class="linenos"> 6</span>            <span class="k">return</span> <span class="n">Integer</span><span class="o">.</span><span class="n">parseInt</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">getProperty</span><span class="p">(</span><span class="n">key</span><span class="p">));</span>
<span class="linenos"> 7</span>        <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="ne">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos"> 8</span>            <span class="k">return</span> <span class="n">defaultValue</span><span class="p">;</span>
<span class="linenos"> 9</span>        <span class="p">}</span>
<span class="linenos">10</span>    <span class="p">}</span>
<span class="linenos">11</span>
<span class="linenos">12</span>    <span class="n">public</span> <span class="n">static</span> <span class="n">void</span> <span class="n">main</span><span class="p">(</span><span class="n">String</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos">13</span>        <span class="n">String</span> <span class="n">srcFile</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="linenos">14</span>        <span class="n">String</span> <span class="n">dstFile</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="linenos">15</span>        <span class="n">Properties</span> <span class="n">p</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Properties</span><span class="p">();</span>
<span class="linenos">16</span>        <span class="k">try</span> <span class="p">{</span>
<span class="linenos">17</span>            <span class="n">FileInputStream</span> <span class="n">propFile</span> <span class="o">=</span> <span class="n">new</span> <span class="n">FileInputStream</span><span class="p">(</span><span class="s2">&quot;FileCopy1.rc&quot;</span><span class="p">);</span>
<span class="linenos">18</span>            <span class="n">p</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">propFile</span><span class="p">);</span>
<span class="linenos">19</span>        <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="ne">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos">20</span>            <span class="n">System</span><span class="o">.</span><span class="n">err</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="s2">&quot;FileCopy1: Can&#39;t load Properties&quot;</span><span class="p">);</span>
<span class="linenos">21</span>        <span class="p">}</span>
<span class="linenos">22</span>
<span class="linenos">23</span>        <span class="nb">int</span> <span class="n">buffers</span> <span class="o">=</span> <span class="n">getIntProp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s2">&quot;buffers&quot;</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>
<span class="linenos">24</span>        <span class="nb">int</span> <span class="n">bufferSize</span> <span class="o">=</span> <span class="n">getIntProp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s2">&quot;bufferSize&quot;</span><span class="p">,</span> <span class="mi">4096</span><span class="p">);</span>
<span class="linenos">25</span>
<span class="linenos">26</span>        <span class="n">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="s2">&quot;source = &quot;</span> <span class="o">+</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="linenos">27</span>        <span class="n">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="s2">&quot;destination = &quot;</span> <span class="o">+</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="linenos">28</span>        <span class="n">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="s2">&quot;buffers = &quot;</span> <span class="o">+</span> <span class="n">buffers</span><span class="p">);</span>
<span class="linenos">29</span>        <span class="n">System</span><span class="o">.</span><span class="n">out</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="s2">&quot;bufferSize = &quot;</span> <span class="o">+</span> <span class="n">bufferSize</span><span class="p">);</span>
<span class="linenos">30</span>
<span class="linenos">31</span>        <span class="n">Pool</span> <span class="n">pool</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Pool</span><span class="p">(</span><span class="n">buffers</span><span class="p">,</span> <span class="n">bufferSize</span><span class="p">);</span>
<span class="linenos">32</span>        <span class="n">BufferQueue</span> <span class="n">copyBuffers</span> <span class="o">=</span> <span class="n">new</span> <span class="n">BufferQueue</span><span class="p">();</span>
<span class="linenos">33</span>
<span class="linenos">34</span>        <span class="n">FileCopyReader1</span> <span class="n">src</span><span class="p">;</span>
<span class="linenos">35</span>
<span class="linenos">36</span>        <span class="k">try</span> <span class="p">{</span>
<span class="linenos">37</span>            <span class="n">src</span> <span class="o">=</span> <span class="n">new</span> <span class="n">FileCopyReader1</span><span class="p">(</span><span class="n">srcFile</span><span class="p">,</span> <span class="n">pool</span><span class="p">,</span> <span class="n">copyBuffers</span><span class="p">);</span>
<span class="linenos">38</span>        <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="ne">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos">39</span>            <span class="n">System</span><span class="o">.</span><span class="n">err</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="s2">&quot;Cannot open &quot;</span> <span class="o">+</span> <span class="n">srcFile</span><span class="p">);</span>
<span class="linenos">40</span>            <span class="k">return</span><span class="p">;</span>
<span class="linenos">41</span>        <span class="p">}</span>
<span class="linenos">42</span>
<span class="linenos">43</span>        <span class="n">FileCopyWriter1</span> <span class="n">dst</span><span class="p">;</span>
<span class="linenos">44</span>
<span class="linenos">45</span>        <span class="k">try</span> <span class="p">{</span>
<span class="linenos">46</span>            <span class="n">dst</span> <span class="o">=</span> <span class="n">new</span> <span class="n">FileCopyWriter1</span><span class="p">(</span><span class="n">dstFile</span><span class="p">,</span> <span class="n">pool</span><span class="p">,</span> <span class="n">copyBuffers</span><span class="p">);</span>
<span class="linenos">47</span>        <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="ne">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos">48</span>            <span class="n">System</span><span class="o">.</span><span class="n">err</span><span class="o">.</span><span class="n">println</span><span class="p">(</span><span class="s2">&quot;Cannot open &quot;</span> <span class="o">+</span> <span class="n">dstFile</span><span class="p">);</span>
<span class="linenos">49</span>            <span class="k">return</span><span class="p">;</span>
<span class="linenos">50</span>        <span class="p">}</span>
<span class="linenos">51</span>
<span class="linenos">52</span>        <span class="n">src</span><span class="o">.</span><span class="n">start</span><span class="p">();</span>
<span class="linenos">53</span>        <span class="n">dst</span><span class="o">.</span><span class="n">start</span><span class="p">();</span>
<span class="linenos">54</span>
<span class="linenos">55</span>        <span class="k">try</span> <span class="p">{</span>
<span class="linenos">56</span>            <span class="n">src</span><span class="o">.</span><span class="n">join</span><span class="p">();</span>
<span class="linenos">57</span>        <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="ne">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos">58</span>        <span class="p">}</span>
<span class="linenos">59</span>
<span class="linenos">60</span>        <span class="k">try</span> <span class="p">{</span>
<span class="linenos">61</span>            <span class="n">dst</span><span class="o">.</span><span class="n">join</span><span class="p">();</span>
<span class="linenos">62</span>        <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="ne">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos">63</span>        <span class="p">}</span>
<span class="linenos">64</span>    <span class="p">}</span>
<span class="linenos">65</span><span class="p">}</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="n">public</span> <span class="k">class</span> <span class="nc">FileCopyReader1</span> <span class="n">extends</span> <span class="n">Thread</span> <span class="p">{</span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span>    <span class="n">private</span> <span class="n">FileReader</span> <span class="n">fr</span><span class="p">;</span>
<span class="linenos"> 4</span>    <span class="n">private</span> <span class="n">Pool</span> <span class="n">pool</span><span class="p">;</span>
<span class="linenos"> 5</span>    <span class="n">private</span> <span class="n">BufferQueue</span> <span class="n">copyBuffers</span><span class="p">;</span>
<span class="linenos"> 6</span>
<span class="linenos"> 7</span>    <span class="n">public</span> <span class="n">FileCopyReader1</span><span class="p">(</span><span class="n">String</span> <span class="n">filename</span><span class="p">,</span> <span class="n">Pool</span> <span class="n">pool</span><span class="p">,</span> <span class="n">BufferQueue</span> <span class="n">copyBuffers</span><span class="p">)</span>
<span class="linenos"> 8</span>            <span class="n">throws</span> <span class="n">IOException</span> <span class="p">{</span>
<span class="linenos"> 9</span>        <span class="n">this</span><span class="o">.</span><span class="n">pool</span> <span class="o">=</span> <span class="n">pool</span><span class="p">;</span>
<span class="linenos">10</span>        <span class="n">this</span><span class="o">.</span><span class="n">copyBuffers</span> <span class="o">=</span> <span class="n">copyBuffers</span><span class="p">;</span>
<span class="linenos">11</span>        <span class="n">fr</span> <span class="o">=</span> <span class="n">new</span> <span class="n">FileReader</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span>
<span class="linenos">12</span>    <span class="p">}</span>
<span class="linenos">13</span>
<span class="linenos">14</span>    <span class="n">public</span> <span class="n">void</span> <span class="n">run</span><span class="p">()</span> <span class="p">{</span>
<span class="linenos">15</span>        <span class="n">Buffer</span> <span class="n">buffer</span><span class="p">;</span>
<span class="linenos">16</span>        <span class="nb">int</span> <span class="n">bytesRead</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="linenos">17</span>
<span class="linenos">18</span>        <span class="n">do</span> <span class="p">{</span>
<span class="linenos">19</span>            <span class="k">try</span> <span class="p">{</span>
<span class="linenos">20</span>                <span class="n">buffer</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">use</span><span class="p">();</span>
<span class="linenos">21</span>                <span class="n">bytesRead</span> <span class="o">=</span> <span class="n">fr</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">buffer</span><span class="o">.</span><span class="n">getBuffer</span><span class="p">());</span>
<span class="linenos">22</span>            <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="ne">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos">23</span>                <span class="n">buffer</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Buffer</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="linenos">24</span>                <span class="n">bytesRead</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="linenos">25</span>            <span class="p">}</span>
<span class="linenos">26</span>            <span class="k">if</span> <span class="p">(</span><span class="n">bytesRead</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos">27</span>                <span class="n">buffer</span><span class="o">.</span><span class="n">setSize</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="linenos">28</span>            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="linenos">29</span>                <span class="n">buffer</span><span class="o">.</span><span class="n">setSize</span><span class="p">(</span><span class="n">bytesRead</span><span class="p">);</span>
<span class="linenos">30</span>            <span class="p">}</span>
<span class="linenos">31</span>            <span class="n">copyBuffers</span><span class="o">.</span><span class="n">enqueueBuffer</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
<span class="linenos">32</span>        <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">bytesRead</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
<span class="linenos">33</span>
<span class="linenos">34</span>        <span class="k">try</span> <span class="p">{</span>
<span class="linenos">35</span>            <span class="n">fr</span><span class="o">.</span><span class="n">close</span><span class="p">();</span>
<span class="linenos">36</span>        <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="ne">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos">37</span>            <span class="k">return</span><span class="p">;</span>
<span class="linenos">38</span>        <span class="p">}</span>
<span class="linenos">39</span>    <span class="p">}</span>
<span class="linenos">40</span><span class="p">}</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="n">public</span> <span class="k">class</span> <span class="nc">FileCopyWriter1</span> <span class="n">extends</span> <span class="n">Thread</span> <span class="p">{</span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span>    <span class="n">private</span> <span class="n">FileWriter</span> <span class="n">fw</span><span class="p">;</span>
<span class="linenos"> 4</span>    <span class="n">private</span> <span class="n">Pool</span> <span class="n">pool</span><span class="p">;</span>
<span class="linenos"> 5</span>    <span class="n">private</span> <span class="n">BufferQueue</span> <span class="n">copyBuffers</span><span class="p">;</span>
<span class="linenos"> 6</span>
<span class="linenos"> 7</span>    <span class="n">public</span> <span class="n">FileCopyWriter1</span><span class="p">(</span><span class="n">String</span> <span class="n">filename</span><span class="p">,</span> <span class="n">Pool</span> <span class="n">pool</span><span class="p">,</span> <span class="n">BufferQueue</span> <span class="n">copyBuffers</span><span class="p">)</span>
<span class="linenos"> 8</span>            <span class="n">throws</span> <span class="n">IOException</span> <span class="p">{</span>
<span class="linenos"> 9</span>
<span class="linenos">10</span>        <span class="n">this</span><span class="o">.</span><span class="n">pool</span> <span class="o">=</span> <span class="n">pool</span><span class="p">;</span>
<span class="linenos">11</span>        <span class="n">this</span><span class="o">.</span><span class="n">copyBuffers</span> <span class="o">=</span> <span class="n">copyBuffers</span><span class="p">;</span>
<span class="linenos">12</span>        <span class="n">fw</span> <span class="o">=</span> <span class="n">new</span> <span class="n">FileWriter</span><span class="p">(</span><span class="n">filename</span><span class="p">);</span>
<span class="linenos">13</span>    <span class="p">}</span>
<span class="linenos">14</span>
<span class="linenos">15</span>    <span class="n">public</span> <span class="n">void</span> <span class="n">run</span><span class="p">()</span> <span class="p">{</span>
<span class="linenos">16</span>        <span class="n">Buffer</span> <span class="n">buffer</span><span class="p">;</span>
<span class="linenos">17</span>
<span class="linenos">18</span>        <span class="k">while</span> <span class="p">(</span><span class="n">true</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos">19</span>            <span class="k">try</span> <span class="p">{</span>
<span class="linenos">20</span>                <span class="n">buffer</span> <span class="o">=</span> <span class="n">copyBuffers</span><span class="o">.</span><span class="n">dequeueBuffer</span><span class="p">();</span>
<span class="linenos">21</span>            <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="ne">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos">22</span>                <span class="k">return</span><span class="p">;</span>
<span class="linenos">23</span>            <span class="p">}</span>
<span class="linenos">24</span>            <span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="o">.</span><span class="n">getSize</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos">25</span>                <span class="k">try</span> <span class="p">{</span>
<span class="linenos">26</span>                    <span class="n">char</span><span class="p">[]</span> <span class="n">bufferData</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">.</span><span class="n">getBuffer</span><span class="p">();</span>
<span class="linenos">27</span>                    <span class="nb">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">bufferData</span><span class="o">.</span><span class="n">length</span><span class="p">;</span>
<span class="linenos">28</span>                    <span class="n">fw</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">bufferData</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<span class="linenos">29</span>                <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="ne">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos">30</span>                    <span class="k">break</span><span class="p">;</span>
<span class="linenos">31</span>                <span class="p">}</span>
<span class="linenos">32</span>                <span class="n">pool</span><span class="o">.</span><span class="n">release</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
<span class="linenos">33</span>            <span class="p">}</span> <span class="k">else</span>
<span class="linenos">34</span>                <span class="k">break</span><span class="p">;</span>
<span class="linenos">35</span>        <span class="p">}</span>
<span class="linenos">36</span>
<span class="linenos">37</span>        <span class="k">try</span> <span class="p">{</span>
<span class="linenos">38</span>            <span class="n">fw</span><span class="o">.</span><span class="n">close</span><span class="p">();</span>
<span class="linenos">39</span>        <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="ne">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos">40</span>            <span class="k">return</span><span class="p">;</span>
<span class="linenos">41</span>        <span class="p">}</span>
<span class="linenos">42</span>    <span class="p">}</span>
<span class="linenos">43</span><span class="p">}</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span>
<span class="linenos"> 2</span><span class="n">public</span> <span class="k">class</span> <span class="nc">Buffer</span> <span class="p">{</span>
<span class="linenos"> 3</span>    <span class="n">private</span> <span class="n">char</span><span class="p">[]</span> <span class="n">buffer</span><span class="p">;</span>
<span class="linenos"> 4</span>    <span class="n">private</span> <span class="nb">int</span> <span class="n">size</span><span class="p">;</span>
<span class="linenos"> 5</span>
<span class="linenos"> 6</span>    <span class="n">public</span> <span class="n">Buffer</span><span class="p">(</span><span class="nb">int</span> <span class="n">bufferSize</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos"> 7</span>        <span class="n">buffer</span> <span class="o">=</span> <span class="n">new</span> <span class="n">char</span><span class="p">[</span><span class="n">bufferSize</span><span class="p">];</span>
<span class="linenos"> 8</span>        <span class="n">size</span> <span class="o">=</span> <span class="n">bufferSize</span><span class="p">;</span>
<span class="linenos"> 9</span>    <span class="p">}</span>
<span class="linenos">10</span>
<span class="linenos">11</span>    <span class="n">public</span> <span class="n">char</span><span class="p">[]</span> <span class="n">getBuffer</span><span class="p">()</span> <span class="p">{</span>
<span class="linenos">12</span>        <span class="k">return</span> <span class="n">buffer</span><span class="p">;</span>
<span class="linenos">13</span>    <span class="p">}</span>
<span class="linenos">14</span>
<span class="linenos">15</span>    <span class="n">public</span> <span class="nb">int</span> <span class="n">getSize</span><span class="p">()</span> <span class="p">{</span>
<span class="linenos">16</span>        <span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="linenos">17</span>    <span class="p">}</span>
<span class="linenos">18</span>
<span class="linenos">19</span>    <span class="n">public</span> <span class="n">void</span> <span class="n">setSize</span><span class="p">(</span><span class="nb">int</span> <span class="n">newSize</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos">20</span>        <span class="k">if</span> <span class="p">(</span><span class="n">newSize</span> <span class="o">&gt;</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos">21</span>            <span class="n">char</span><span class="p">[]</span> <span class="n">newBuffer</span> <span class="o">=</span> <span class="n">new</span> <span class="n">char</span><span class="p">[</span><span class="n">newSize</span><span class="p">];</span>
<span class="linenos">22</span>            <span class="n">System</span><span class="o">.</span><span class="n">arraycopy</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">newBuffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<span class="linenos">23</span>            <span class="n">buffer</span> <span class="o">=</span> <span class="n">newBuffer</span><span class="p">;</span>
<span class="linenos">24</span>        <span class="p">}</span>
<span class="linenos">25</span>
<span class="linenos">26</span>        <span class="n">size</span> <span class="o">=</span> <span class="n">newSize</span><span class="p">;</span>
<span class="linenos">27</span>    <span class="p">}</span>
<span class="linenos">28</span><span class="p">}</span>
<span class="linenos">29</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="n">public</span> <span class="k">class</span> <span class="nc">BufferQueue</span> <span class="p">{</span>
<span class="linenos"> 2</span>    <span class="n">public</span> <span class="n">Vector</span><span class="o">&lt;</span><span class="n">Buffer</span><span class="o">&gt;</span> <span class="n">buffers</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Vector</span><span class="o">&lt;</span><span class="n">Buffer</span><span class="o">&gt;</span><span class="p">();</span>
<span class="linenos"> 3</span>
<span class="linenos"> 4</span>    <span class="n">public</span> <span class="n">synchronized</span> <span class="n">void</span> <span class="n">enqueueBuffer</span><span class="p">(</span><span class="n">Buffer</span> <span class="n">b</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos"> 5</span>        <span class="k">if</span> <span class="p">(</span><span class="n">buffers</span><span class="o">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<span class="linenos"> 6</span>            <span class="n">notify</span><span class="p">();</span>
<span class="linenos"> 7</span>        <span class="n">buffers</span><span class="o">.</span><span class="n">addElement</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
<span class="linenos"> 8</span>    <span class="p">}</span>
<span class="linenos"> 9</span>
<span class="linenos">10</span>    <span class="n">public</span> <span class="n">synchronized</span> <span class="n">Buffer</span> <span class="n">dequeueBuffer</span><span class="p">()</span> <span class="n">throws</span> <span class="n">InterruptedException</span> <span class="p">{</span>
<span class="linenos">11</span>        <span class="k">while</span> <span class="p">(</span><span class="n">buffers</span><span class="o">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<span class="linenos">12</span>            <span class="n">wait</span><span class="p">();</span>
<span class="linenos">13</span>
<span class="linenos">14</span>        <span class="n">Buffer</span> <span class="n">firstBuffer</span> <span class="o">=</span> <span class="n">buffers</span><span class="o">.</span><span class="n">elementAt</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="linenos">15</span>        <span class="n">buffers</span><span class="o">.</span><span class="n">removeElementAt</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="linenos">16</span>        <span class="k">return</span> <span class="n">firstBuffer</span><span class="p">;</span>
<span class="linenos">17</span>    <span class="p">}</span>
<span class="linenos">18</span><span class="p">}</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="n">public</span> <span class="k">class</span> <span class="nc">Pool</span> <span class="p">{</span>
<span class="linenos"> 2</span>
<span class="linenos"> 3</span>    <span class="n">Vector</span><span class="o">&lt;</span><span class="n">Buffer</span><span class="o">&gt;</span> <span class="n">freeBufferList</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Vector</span><span class="o">&lt;</span><span class="n">Buffer</span><span class="o">&gt;</span><span class="p">();</span>
<span class="linenos"> 4</span>    <span class="n">OutputStream</span> <span class="n">debug</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">out</span><span class="p">;</span>
<span class="linenos"> 5</span>    <span class="nb">int</span> <span class="n">buffers</span><span class="p">,</span> <span class="n">bufferSize</span><span class="p">;</span>
<span class="linenos"> 6</span>
<span class="linenos"> 7</span>    <span class="n">public</span> <span class="n">Pool</span><span class="p">(</span><span class="nb">int</span> <span class="n">buffers</span><span class="p">,</span> <span class="nb">int</span> <span class="n">bufferSize</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos"> 8</span>        <span class="n">this</span><span class="o">.</span><span class="n">buffers</span> <span class="o">=</span> <span class="n">buffers</span><span class="p">;</span>
<span class="linenos"> 9</span>        <span class="n">this</span><span class="o">.</span><span class="n">bufferSize</span> <span class="o">=</span> <span class="n">bufferSize</span><span class="p">;</span>
<span class="linenos">10</span>        <span class="n">freeBufferList</span><span class="o">.</span><span class="n">ensureCapacity</span><span class="p">(</span><span class="n">buffers</span><span class="p">);</span>
<span class="linenos">11</span>
<span class="linenos">12</span>        <span class="k">for</span> <span class="p">(</span><span class="nb">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">buffers</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="linenos">13</span>            <span class="n">freeBufferList</span><span class="o">.</span><span class="n">addElement</span><span class="p">(</span><span class="n">new</span> <span class="n">Buffer</span><span class="p">(</span><span class="n">bufferSize</span><span class="p">));</span>
<span class="linenos">14</span>    <span class="p">}</span>
<span class="linenos">15</span>
<span class="linenos">16</span>    <span class="n">public</span> <span class="n">synchronized</span> <span class="n">Buffer</span> <span class="n">use</span><span class="p">()</span> <span class="n">throws</span> <span class="n">InterruptedException</span> <span class="p">{</span>
<span class="linenos">17</span>        <span class="k">while</span> <span class="p">(</span><span class="n">freeBufferList</span><span class="o">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<span class="linenos">18</span>            <span class="n">wait</span><span class="p">();</span>
<span class="linenos">19</span>        <span class="n">Buffer</span> <span class="n">nextBuffer</span> <span class="o">=</span> <span class="n">freeBufferList</span><span class="o">.</span><span class="n">lastElement</span><span class="p">();</span>
<span class="linenos">20</span>        <span class="n">freeBufferList</span><span class="o">.</span><span class="n">removeElement</span><span class="p">(</span><span class="n">nextBuffer</span><span class="p">);</span>
<span class="linenos">21</span>        <span class="k">return</span> <span class="n">nextBuffer</span><span class="p">;</span>
<span class="linenos">22</span>    <span class="p">}</span>
<span class="linenos">23</span>
<span class="linenos">24</span>    <span class="n">public</span> <span class="n">synchronized</span> <span class="n">void</span> <span class="n">release</span><span class="p">(</span><span class="n">Buffer</span> <span class="n">oldBuffer</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos">25</span>        <span class="k">if</span> <span class="p">(</span><span class="n">freeBufferList</span><span class="o">.</span><span class="n">size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<span class="linenos">26</span>            <span class="n">notify</span><span class="p">();</span>
<span class="linenos">27</span>
<span class="linenos">28</span>        <span class="k">if</span> <span class="p">(</span><span class="n">freeBufferList</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">oldBuffer</span><span class="p">))</span>
<span class="linenos">29</span>            <span class="k">return</span><span class="p">;</span>
<span class="linenos">30</span>
<span class="linenos">31</span>        <span class="k">if</span> <span class="p">(</span><span class="n">oldBuffer</span><span class="o">.</span><span class="n">getSize</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">bufferSize</span><span class="p">)</span>
<span class="linenos">32</span>            <span class="n">oldBuffer</span><span class="o">.</span><span class="n">setSize</span><span class="p">(</span><span class="n">bufferSize</span><span class="p">);</span>
<span class="linenos">33</span>
<span class="linenos">34</span>        <span class="n">freeBufferList</span><span class="o">.</span><span class="n">addElement</span><span class="p">(</span><span class="n">oldBuffer</span><span class="p">);</span>
<span class="linenos">35</span>    <span class="p">}</span>
<span class="linenos">36</span><span class="p">}</span>
</pre></div>
</div>
</section>
<section id="execution">
<h2>Execution<a class="headerlink" href="#execution" title="Permalink to this headline"></a></h2>
<p>You can run FileCopy0 and FileCopy1 by using the corresponding Gradle tasks.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="n">task</span> <span class="n">FileCopy0</span><span class="p">(</span><span class="n">dependsOn</span><span class="p">:</span> <span class="s1">&#39;classes&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="p">:</span> <span class="n">JavaExec</span><span class="p">)</span> <span class="p">{</span>
<span class="linenos">2</span>    <span class="n">main</span> <span class="o">=</span> <span class="s1">&#39;info.jhpc.textbook.chapter03.FileCopy0&#39;</span>
<span class="linenos">3</span>    <span class="n">classpath</span> <span class="o">=</span> <span class="n">sourceSets</span><span class="o">.</span><span class="n">main</span><span class="o">.</span><span class="n">runtimeClasspath</span>
<span class="linenos">4</span>    <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">fc0_src</span><span class="p">,</span> <span class="n">fc0_dest</span><span class="p">]</span>
<span class="linenos">5</span><span class="p">}</span>
</pre></div>
</div>
<p>As shown, there are two properties you can set: <code class="docutils literal notranslate"><span class="pre">fc0_src</span></code> and <code class="docutils literal notranslate"><span class="pre">fc0_dest</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gradle</span> <span class="n">FileCopy0</span> <span class="o">-</span><span class="n">Pfc0_src</span><span class="o">=</span><span class="n">inputFile</span> <span class="o">-</span><span class="n">Pfc0_dest</span><span class="o">=</span><span class="n">outputFile</span>
</pre></div>
</div>
<p>You can also run FileCopy1 (the same parameter names are used):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gradle</span> <span class="n">FileCopy1</span> <span class="o">-</span><span class="n">Pfc0_src</span><span class="o">=</span><span class="n">inputFile</span> <span class="o">-</span><span class="n">Pfc0_dest</span><span class="o">=</span><span class="n">outputFile</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../networking/networking.html" class="btn btn-neutral float-left" title="Networking Primer" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../storage/storage.html" class="btn btn-neutral float-right" title="Distributed Systems and Storage" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2013-2019, George K. Thiruvathukal and Sarah Kaylor.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>